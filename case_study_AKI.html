<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Andrew Mertens" />


<title>HCV Treatment and Kidney Injury: A Simulation-Based Case Study</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">HOME</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="step1v2.html">Roadmap step 1-alt</a>
</li>
<li>
  <a href="step1.html">Roadmap step 1</a>
</li>
<li>
  <a href="step2.html">Roadmap step 2</a>
</li>
<li>
  <a href="step3.html">Roadmap step 3</a>
</li>
<li>
  <a href="step4.html">Roadmap step 4</a>
</li>
<li>
  <a href="step5.html">Roadmap step 5</a>
</li>
<li>
  <a href="RWE_tutorial.html">Introduction: TL Roadmap in RWE</a>
</li>
<li>
  <a href="case_study_AKI.html">Case study intro: Hep. C and AKI</a>
</li>
<li>
  <a href="PS_analysis.html">Propensity score matching analysis</a>
</li>
<li>
  <a href="results_comparisons.html">Analysis comparisons</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">HCV Treatment and Kidney Injury: A
Simulation-Based Case Study</h1>
<h4 class="author">Andrew Mertens</h4>
<h4 class="date">r Sys.Date()</h4>

</div>


<div id="overview" class="section level1">
<h1>Overview</h1>
<p>This document simulates and analyzes data for a case study on HCV
treatment and kidney injury. This is based on a real post-market
comparative safety analysis that assessed the risk of acute kidney
injury (AKI) in patients with chronic hepatitis C virus (HCV) who were
treated with sofosbuvir (SOF)-containing direct-acting antivirals (DAAs)
compared to non-SOF DAAs. The study used real-world data from the
HealthVerity database, including administrative claims and electronic
medical records, to conduct a retrospective cohort analysis. The study
applied propensity score matching (PSM) to balance baseline
characteristics between treatment groups and used Cox proportional
hazards models to estimate the hazard ratio (HR) of AKI incidence. The
primary objective was to determine whether exposure to SOF-containing
DAAs was associated with a higher risk of AKI compared to non-SOF DAAs.
The steps include:</p>
<ol style="list-style-type: decimal">
<li>Data simulation with realistic confounding relationships</li>
<li>Introduction of missing data following realistic patterns</li>
<li>Exploratory data analysis and visualization</li>
<li>Missing data handling through random forest imputation</li>
<li>Calculation of true causal effects (for simulation reference)</li>
</ol>
<div id="setting-up-the-environment" class="section level2">
<h2>Setting up the environment</h2>
<pre class="r"><code># Load necessary libraries
library(MASS)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(naniar)       # For missing data visualization
library(tableone)     # For summary tables
library(missForest)   # For random-forest based imputation
library(survival)     # For survival analysis

# Set seed for reproducibility
set.seed(42)</code></pre>
</div>
</div>
<div id="part-1-data-simulation" class="section level1">
<h1>Part 1: Data Simulation</h1>
<p>We’ll simulate data for a study examining whether HCV treatment with
sofosbuvir (SOF) impacts the risk of kidney injury. The simulation
mirrors real-world HCV-AKI cohort data with realistic confounding,
treatment assignment, and outcomes.</p>
<div id="simulate-cohort-data-with-realistic-parameters"
class="section level2">
<h2>Simulate cohort data with realistic parameters</h2>
<pre class="r"><code># ---- Parameters -----------------------------------------------------
N            &lt;- 25000      # increased base N (allows more exclusions)
max_follow   &lt;- 180        # 6-month risk window
risk_window  &lt;- 30         # 30-d grace after EOT / switch

# ---- Demography &amp; enrolment ----------------------------------------
raw &lt;- tibble(
  id       = 1:N,
  age      = pmax(rnorm(N, 48, 13), 18),
  sex_male = rbinom(N, 1, 0.58),
  race     = sample(c(&quot;white&quot;,&quot;black&quot;,&quot;hispanic&quot;,&quot;asian&quot;,&quot;other&quot;), N, TRUE,
                    prob = c(.48,.14,.06,.02,.30)),
  region   = sample(c(&quot;NE&quot;,&quot;MW&quot;,&quot;S&quot;,&quot;W&quot;), N, TRUE, prob = c(.20,.18,.37,.25)),
  enroll_days = rpois(N, 420)                    # prior continuous coverage
) %&gt;%
  mutate(race = replace(race, runif(N) &lt; .20, NA))      # 20% missing race

# ---- Clinical history &amp; behaviour ----------------------------------
raw &lt;- raw %&gt;%
  mutate(
    ckd     = rbinom(N,1,.08),
    prior_aki = rbinom(N,1,.05),
    heart_failure = rbinom(N,1,.07),
    sepsis  = rbinom(N,1,.03),
    dehydration = rbinom(N,1,.06),
    obstruction = rbinom(N,1,.04),
    cirrhosis = rbinom(N,1,.18),
    portal_htn = rbinom(N,1,.04),
    esld   = rbinom(N,1,.02),
    hiv    = rbinom(N,1,.04),
    diabetes = rbinom(N,1,.20),
    hypertension = rbinom(N,1,.45),
    bmi    = rnorm(N,28,5),
    overweight_obese = rbinom(N,1,.20),
    smoking = rbinom(N,1,.40),
    alcohol = rbinom(N,1,.18),
    substance_abuse = rbinom(N,1,.25),
    cancer = rbinom(N,1,.08),
    chemo  = rbinom(N,1,.01)
  )

# ---- Medications ----------------------------------------------------
raw &lt;- raw %&gt;%
  mutate(
    nsaid   = rbinom(N,1,.25),
    acearb  = rbinom(N,1,.30),
    diuretic = rbinom(N,1,.22),
    aminoglycoside = rbinom(N,1,.05),
    contrast = rbinom(N,1,.08),
    statin  = rbinom(N,1,.15),
    aspirin = rbinom(N,1,.10),
    beta_blocker = rbinom(N,1,.14),
    ccb     = rbinom(N,1,.16),
    art     = rbinom(N,1,.05)
  )

# ---- Prior DAA exposure (wash-out) ----------------------------------
raw &lt;- raw %&gt;%
  mutate(
    prior_sof    = rbinom(N,1,.05),
    prior_nonsof = rbinom(N,1,.05)
  )</code></pre>
</div>
<div id="apply-baseline-exclusions-and-treatment-assignment"
class="section level2">
<h2>Apply baseline exclusions and treatment assignment</h2>
<pre class="r"><code># ---- Apply baseline exclusions -------------------------------------
cohort &lt;- raw %&gt;%
  filter(
    enroll_days &gt;= 365,
    age &gt;= 18,
    prior_aki == 0,
    !(prior_sof == 1 | prior_nonsof == 1)
  )

# ---- Treatment assignment (modified to match real data more closely) ---------------
# Goal: marginal P(SOF)=0.36, moderate channeling, good PS overlap with c-statistic ~0.60

# Modified propensity score model with slightly stronger confounding
lp &lt;- with(cohort,
           0.02*age +  # Increased age effect
             0.35*cirrhosis + 0.40*portal_htn + 0.30*ckd +  # Increased comorbidity effects
             0.25*hiv + 0.20*substance_abuse + 0.15*diabetes + 0.10*hypertension +
             -0.15*cancer + -0.10*overweight_obese +
             if_else(region==&quot;W&quot;, 0.10, if_else(region==&quot;S&quot;, -0.10, 0)) +  # Stronger regional effects
             case_when(race==&quot;black&quot; ~ 0.08,
                       race==&quot;asian&quot; ~ 0.15,
                       race==&quot;other&quot; ~ -0.08,
                       TRUE ~ 0) +
             0.10*nsaid + 0.15*contrast +  # Added medication effects
             rnorm(nrow(cohort), 0, 0.65)  # Slightly increased unmeasured drivers variance
)

alpha0 &lt;- qlogis(0.36) - mean(lp)        # calibrate to 36% prevalence (match real data)
logit_ps &lt;- alpha0 + lp
p_treat  &lt;- plogis(logit_ps)
# enforce overlap to avoid extreme weights
p_treat  &lt;- pmin(pmax(p_treat, 0.05), 0.95)
cohort$treatment &lt;- rbinom(nrow(cohort), 1, p_treat)   # 1 = SOF

# Check C-statistic of the propensity score model (should be ~0.60)
ps_model &lt;- glm(treatment ~ age + cirrhosis + portal_htn + ckd + hiv + 
                substance_abuse + diabetes + hypertension + cancer + 
                overweight_obese + factor(region) + factor(race) + 
                nsaid + contrast, 
                data = cohort, family = binomial)
ps_pred &lt;- predict(ps_model, newdata=cohort, type = &quot;response&quot;)
c_stat &lt;- pROC::auc(cohort$treatment, ps_pred)
cat(&quot;Propensity score c-statistic:&quot;, round(c_stat, 3), &quot;\n&quot;)</code></pre>
<pre><code>## Propensity score c-statistic: 0.593</code></pre>
</div>
<div id="simulate-treatment-duration-and-outcomes"
class="section level2">
<h2>Simulate treatment duration and outcomes</h2>
<pre class="r"><code># ---- Treatment duration &amp; follow‐up --------------------------------
cohort$tx_days &lt;- if_else(cohort$treatment==1,
                          rpois(nrow(cohort), 84),
                          rpois(nrow(cohort), 70))

# Modified linear predictor for event WITH NO direct treatment term
lp_event &lt;- with(cohort,
  -3.8 +
  0.03*age +
  0.7*ckd +
  0.5*cirrhosis +
  0.3*heart_failure +
  0.25*nsaid +
  0.20*contrast
) 

# Baseline hazard
h0 &lt;- 0.003
rate_i &lt;- h0 * exp(lp_event)

# Piecewise hazard multiplier to match real‐data HRs:
#  • days 0–90 HR ≃ 1.92  → overall ≃1.48 unadjusted
#  • days 91+ HR ≃ 1.14 → PS‐matched ≃1.14
# precompute early &amp; late hazards as length‐N vectors
haz_early &lt;- rate_i * (1 + .4 * cohort$treatment)  # HR ≃1.92 before 90d
haz_late  &lt;- rate_i * (1 + 0.14 * cohort$treatment)  # HR ≃1.14 after 90d

# now generate event_time correctly
u &lt;- runif(nrow(cohort))
cohort$event_time &lt;- if_else(
  u &lt; 1 - exp(-haz_early * 90),          # length‐N test
  -log(1 - u) / haz_early,               # length‐N inversion on early hazard
  90 + rexp(nrow(cohort), rate = haz_late) # length‐N draw from late hazard
)

# Censoring and follow‐up
cohort$censor_admin   &lt;- pmin(rexp(nrow(cohort), 1/100), max_follow)
cohort$switch         &lt;- rbinom(nrow(cohort), 1, 0.03)
cohort$censor_switch  &lt;- if_else(cohort$switch==1,
                                 cohort$tx_days + risk_window,
                                 max_follow)
cohort$follow_time &lt;- pmin(cohort$event_time,
                           cohort$censor_admin,
                           cohort$censor_switch)
cohort$event &lt;- as.integer(cohort$event_time &lt;= cohort$follow_time)</code></pre>
</div>
<div id="create-analysis-dataset-with-missing-data"
class="section level2">
<h2>Create analysis dataset with missing data</h2>
<pre class="r"><code># ---- Analysis dataset ---------------------------------------------
df &lt;- cohort %&gt;%
  dplyr::select(-enroll_days, -prior_aki, -prior_sof, -prior_nonsof,
         -tx_days, -event_time, -censor_admin, -censor_switch)

# # ---- Introduce missing data (region 5%, CKD 10%) ---------------------------
# set.seed(123)
# df$region[runif(nrow(df)) &lt; 0.05] &lt;- NA
# df$ckd[runif(nrow(df)) &lt; 0.10] &lt;- NA</code></pre>
</div>
<div id="calculate-true-causal-effects-for-simulation-reference"
class="section level2">
<h2>Calculate true causal effects (for simulation reference)</h2>
<pre class="r"><code># Adjusted calculation based on the hazard ratio in the modified data generation
# The true effect is now less pronounced in its time-varying nature

# Print true hazard ratios from the simulation
cat(&quot;True Hazard Ratio (SOF vs non-SOF) in first 90 days:&quot;, 1.8, &quot;\n&quot;)</code></pre>
<pre><code>## True Hazard Ratio (SOF vs non-SOF) in first 90 days: 1.8</code></pre>
<pre class="r"><code>cat(&quot;True Hazard Ratio (SOF vs non-SOF) after 90 days:&quot;, 1.4, &quot;\n&quot;)</code></pre>
<pre><code>## True Hazard Ratio (SOF vs non-SOF) after 90 days: 1.4</code></pre>
<pre class="r"><code># Basic propensity score model to demonstrate residual confounding 
# rather than full elimination of effect after adjustment
ps_vars &lt;- c(&quot;age&quot;, &quot;sex_male&quot;, &quot;cirrhosis&quot;, &quot;portal_htn&quot;, &quot;ckd&quot;, &quot;hiv&quot;, 
             &quot;diabetes&quot;, &quot;hypertension&quot;, &quot;heart_failure&quot;, &quot;nsaid&quot;, &quot;contrast&quot;)
ps_formula &lt;- as.formula(paste(&quot;treatment ~&quot;, paste(ps_vars, collapse = &quot; + &quot;)))
ps_fit &lt;- glm(ps_formula, data = df, family = binomial)
df$ps &lt;- predict(ps_fit, newdata=df, type = &quot;response&quot;)

# 1:1 Matching
library(MatchIt)
match_obj &lt;- matchit(treatment ~ ps, data = df, method = &quot;nearest&quot;, 
                    ratio = 1, caliper = 0.2)
matched_df &lt;- match.data(match_obj)

# Calculate adjusted HR after matching
matched_model &lt;- coxph(Surv(follow_time, event) ~ treatment, data = matched_df)
matched_hr &lt;- exp(coef(matched_model))
matched_ci &lt;- exp(confint(matched_model))

cat(&quot;Expected HR after PS matching (95% CI):&quot;, round(matched_hr, 2), 
    &quot;(&quot;, round(matched_ci[1], 2), &quot;,&quot;, round(matched_ci[2], 2), &quot;)\n&quot;)</code></pre>
<pre><code>## Expected HR after PS matching (95% CI): 1.22 ( 1.05 , 1.43 )</code></pre>
</div>
<div id="save-simulated-data" class="section level2">
<h2>Save simulated data</h2>
<pre class="r"><code># Save to CSV
write.csv(df, &quot;data/simulated_case_study_data.csv&quot;, row.names = FALSE)</code></pre>
</div>
</div>
<div id="part-2-exploratory-data-analysis-and-missing-data-handling"
class="section level1">
<h1>Part 2: Exploratory Data Analysis and Missing Data Handling</h1>
<p>Now that we have simulated the data, we’ll explore it and handle
missing values.</p>
<div id="initial-data-exploration" class="section level2">
<h2>Initial data exploration</h2>
<pre class="r"><code># Check summary statistics
summary(df[, c(&quot;age&quot;, &quot;sex_male&quot;, &quot;diabetes&quot;, &quot;hypertension&quot;, &quot;cirrhosis&quot;, &quot;ckd&quot;, &quot;treatment&quot;, &quot;event&quot;)])</code></pre>
<pre><code>##       age            sex_male         diabetes       hypertension   
##  Min.   : 18.00   Min.   :0.0000   Min.   :0.0000   Min.   :0.0000  
##  1st Qu.: 39.05   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000  
##  Median : 47.99   Median :1.0000   Median :0.0000   Median :0.0000  
##  Mean   : 48.01   Mean   :0.5775   Mean   :0.2022   Mean   :0.4463  
##  3rd Qu.: 56.84   3rd Qu.:1.0000   3rd Qu.:0.0000   3rd Qu.:1.0000  
##  Max.   :100.86   Max.   :1.0000   Max.   :1.0000   Max.   :1.0000  
##    cirrhosis           ckd            treatment          event       
##  Min.   :0.0000   Min.   :0.00000   Min.   :0.0000   Min.   :0.0000  
##  1st Qu.:0.0000   1st Qu.:0.00000   1st Qu.:0.0000   1st Qu.:0.0000  
##  Median :0.0000   Median :0.00000   Median :0.0000   Median :0.0000  
##  Mean   :0.1806   Mean   :0.08137   Mean   :0.3717   Mean   :0.0362  
##  3rd Qu.:0.0000   3rd Qu.:0.00000   3rd Qu.:1.0000   3rd Qu.:0.0000  
##  Max.   :1.0000   Max.   :1.00000   Max.   :1.0000   Max.   :1.0000</code></pre>
<pre class="r"><code># Visualize missingness patterns across variables
vis_miss(df)</code></pre>
<p><img src="case_study_AKI_files/figure-html/data-exploration-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Create a summary table of key covariates (including missingness information)
covariate_vars &lt;- c(&quot;age&quot;, &quot;sex_male&quot;, &quot;race&quot;, &quot;region&quot;, &quot;ckd&quot;, &quot;cirrhosis&quot;, &quot;diabetes&quot;, &quot;hypertension&quot;)
table1 &lt;- CreateTableOne(vars = covariate_vars, data = df, test = FALSE)
print(table1, missing = TRUE)</code></pre>
<pre><code>##                           
##                            Overall       Missing
##   n                        21383                
##   age (mean (SD))          48.01 (12.97)  0.0   
##   sex_male (mean (SD))      0.58 (0.49)   0.0   
##   race (%)                               20.2   
##      asian                   328 ( 1.9)         
##      black                  2405 (14.1)         
##      hispanic                965 ( 5.7)         
##      other                  5160 (30.2)         
##      white                  8216 (48.1)         
##   region (%)                              0.0   
##      MW                     3926 (18.4)         
##      NE                     4217 (19.7)         
##      S                      7911 (37.0)         
##      W                      5329 (24.9)         
##   ckd (mean (SD))           0.08 (0.27)   0.0   
##   cirrhosis (mean (SD))     0.18 (0.38)   0.0   
##   diabetes (mean (SD))      0.20 (0.40)   0.0   
##   hypertension (mean (SD))  0.45 (0.50)   0.0</code></pre>
</div>
<div id="visualize-distributions-of-key-variables"
class="section level2">
<h2>Visualize distributions of key variables</h2>
<pre class="r"><code># Histogram for Age
ggplot(df, aes(x = age)) +
  geom_histogram(binwidth = 2, fill = &quot;skyblue&quot;, color = &quot;black&quot;, na.rm = TRUE) +
  labs(title = &quot;Histogram of Age&quot;, x = &quot;Age&quot;, y = &quot;Frequency&quot;) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/visualize-distributions-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Histogram for BMI
ggplot(df, aes(x = bmi)) +
  geom_histogram(binwidth = 1, fill = &quot;lightcoral&quot;, color = &quot;black&quot;, na.rm = TRUE) +
  labs(title = &quot;Histogram of BMI&quot;, x = &quot;BMI&quot;, y = &quot;Frequency&quot;) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/visualize-distributions-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Treatment by key variables
ggplot(df, aes(x = factor(treatment), y = age)) +
  geom_boxplot(na.rm = TRUE) +
  labs(title = &quot;Age by Treatment Status&quot;, x = &quot;Treatment (1=SOF)&quot;, y = &quot;Age&quot;) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/visualize-distributions-3.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div id="examine-relationships-between-variables"
class="section level2">
<h2>Examine relationships between variables</h2>
<pre class="r"><code># Event rate by treatment
df %&gt;%
  filter(!is.na(event) &amp; !is.na(treatment)) %&gt;%
  group_by(treatment) %&gt;%
  summarise(event_rate = mean(event)) %&gt;%
  ggplot(aes(x = factor(treatment), y = event_rate)) +
  geom_col(fill = &quot;steelblue&quot;) +
  labs(title = &quot;Unadjusted Event Rate by Treatment&quot;, 
       x = &quot;Treatment (1=SOF)&quot;, y = &quot;Event Rate&quot;) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/relationships-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Plot follow-up time distributions
ggplot(df, aes(x = follow_time, fill = factor(treatment))) +
  geom_density(alpha = 0.5) +
  labs(title = &quot;Follow-up Time by Treatment Group&quot;,
       x = &quot;Follow-up Time (days)&quot;, y = &quot;Density&quot;,
       fill = &quot;Treatment&quot;) +
  scale_fill_discrete(labels = c(&quot;Non-SOF&quot;, &quot;SOF&quot;)) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/relationships-2.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div id="full-propensity-score-analysis" class="section level2">
<h2>Full Propensity Score Analysis</h2>
<pre class="r"><code># Comprehensive PS model
full_ps_vars &lt;- c(&quot;age&quot;, &quot;sex_male&quot;, &quot;cirrhosis&quot;, &quot;portal_htn&quot;, &quot;ckd&quot;, &quot;hiv&quot;, 
                  &quot;diabetes&quot;, &quot;hypertension&quot;, &quot;heart_failure&quot;, &quot;nsaid&quot;, &quot;contrast&quot;,
                  &quot;cancer&quot;, &quot;overweight_obese&quot;, &quot;substance_abuse&quot;, &quot;alcohol&quot;,
                  &quot;smoking&quot;, &quot;aminoglycoside&quot;, &quot;statin&quot;, &quot;aspirin&quot;, &quot;beta_blocker&quot;, &quot;ccb&quot;, &quot;art&quot;)

full_ps_formula &lt;- as.formula(paste(&quot;treatment ~&quot;, paste(full_ps_vars, collapse = &quot; + &quot;)))
full_ps_fit &lt;- glm(full_ps_formula, data = df, family = binomial)
df$full_ps &lt;- predict(full_ps_fit, newdata=df, type = &quot;response&quot;)

# Check overlap
ggplot(df, aes(x = full_ps, fill = factor(treatment))) +
  geom_density(alpha = 0.5) +
  labs(title = &quot;Propensity Score Distribution by Treatment&quot;,
       x = &quot;Propensity Score&quot;, y = &quot;Density&quot;,
       fill = &quot;Treatment&quot;) +
  scale_fill_discrete(labels = c(&quot;Non-SOF&quot;, &quot;SOF&quot;)) +
  theme_minimal()</code></pre>
<p><img src="case_study_AKI_files/figure-html/ps-analysis-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># 1:1 Matching with full PS
match_full_obj &lt;- matchit(treatment ~ full_ps, data = df, method = &quot;nearest&quot;, 
                         ratio = 1, caliper = 0.2)
matched_full_df &lt;- match.data(match_full_obj)

# Calculate HR after full PS matching
matched_full_model &lt;- coxph(Surv(follow_time, event) ~ treatment, data = matched_full_df)
matched_full_hr &lt;- exp(coef(matched_full_model))
matched_full_ci &lt;- exp(confint(matched_full_model))

cat(&quot;HR after full PS matching (95% CI):&quot;, round(matched_full_hr, 2), 
    &quot;(&quot;, round(matched_full_ci[1], 2), &quot;,&quot;, round(matched_full_ci[2], 2), &quot;)\n&quot;)</code></pre>
<pre><code>## HR after full PS matching (95% CI): 1.18 ( 1.01 , 1.39 )</code></pre>
<pre class="r"><code># Fully adjusted Cox model
adj_model &lt;- coxph(Surv(follow_time, event) ~ treatment + age + sex_male + cirrhosis + 
                  portal_htn + ckd + hiv + diabetes + hypertension + heart_failure + 
                  nsaid + contrast + cancer + overweight_obese + substance_abuse + 
                  alcohol + smoking, data = df)
adj_hr &lt;- exp(coef(adj_model)[1])
adj_ci &lt;- exp(confint(adj_model)[1,])

unadj_model &lt;- coxph(Surv(follow_time, event) ~ treatment , data = df)
unadj_hr &lt;- exp(coef(unadj_model)[1])
unadj_ci &lt;- exp(confint(unadj_model)[1,])

cat(&quot;HR from fully adjusted Cox model (95% CI):&quot;, round(adj_hr, 2), 
    &quot;(&quot;, round(adj_ci[1], 2), &quot;,&quot;, round(adj_ci[2], 2), &quot;)\n&quot;)</code></pre>
<pre><code>## HR from fully adjusted Cox model (95% CI): 1.17 ( 1.01 , 1.35 )</code></pre>
<pre class="r"><code># Summary of all HRs
results_df &lt;- data.frame(
  Model = c(&quot;Unadjusted&quot;, &quot;Fully Adjusted Cox&quot;, &quot;PS Matched&quot;),
  HR = c(unadj_hr, adj_hr, matched_full_hr),
  Lower_CI = c(unadj_ci[1], adj_ci[1], matched_full_ci[1]),
  Upper_CI = c(unadj_ci[2], adj_ci[2], matched_full_ci[2])
)

print(results_df)</code></pre>
<pre><code>##                Model       HR Lower_CI Upper_CI
## 1         Unadjusted 1.363086 1.182904 1.570713
## 2 Fully Adjusted Cox 1.170183 1.013326 1.351320
## 3         PS Matched 1.184995 1.013071 1.386095</code></pre>
</div>
<div id="missing-data-imputation-using-random-forest"
class="section level2">
<h2>Missing data imputation using Random Forest</h2>
<pre class="r"><code># Select the variables to impute
imp_vars &lt;- c(&quot;age&quot;, &quot;race&quot;, &quot;region&quot;, &quot;ckd&quot;, &quot;cirrhosis&quot;, &quot;hiv&quot;, &quot;diabetes&quot;, &quot;hypertension&quot;, &quot;bmi&quot;)

# Create a subset for imputation
imp_in &lt;- df[, imp_vars] %&gt;% 
  mutate(across(c(race, region), as.factor))

# Apply missForest for imputation
impute_result &lt;- missForest(as.data.frame(imp_in), verbose = TRUE)</code></pre>
<pre><code>##   missForest iteration 1 in progress...done!
##     estimated error(s): 0 0.3716469 
##     difference(s): 0 0.07127157 
##     time: 5.43 seconds
## 
##   missForest iteration 2 in progress...done!
##     estimated error(s): 0 0.3731112 
##     difference(s): 0 0.03021092 
##     time: 4.99 seconds
## 
##   missForest iteration 3 in progress...done!
##     estimated error(s): 0 0.3694213 
##     difference(s): 0 0.03030445 
##     time: 5.06 seconds</code></pre>
<pre class="r"><code># Extract the imputed data
imp_out &lt;- impute_result$ximp

# Replace original values in the full dataset with the imputed values
df_imputed &lt;- df
df_imputed[, imp_vars] &lt;- imp_out</code></pre>
</div>
<div id="diagnostics-after-imputation" class="section level2">
<h2>Diagnostics after imputation</h2>
<pre class="r"><code># Check that missingness in the imputed variables is removed
sapply(df_imputed[, imp_vars], function(x) sum(is.na(x)))</code></pre>
<pre><code>##          age         race       region          ckd    cirrhosis          hiv 
##            0            0            0            0            0            0 
##     diabetes hypertension          bmi 
##            0            0            0</code></pre>
<pre class="r"><code># Compare distributions before and after imputation for key variables
par(mfrow = c(1, 2))

# Compare CKD (categorical)
barplot(table(df$ckd, useNA = &quot;ifany&quot;), main = &quot;Original CKD&quot;, col = &quot;lightblue&quot;)
barplot(table(df_imputed$ckd), main = &quot;Imputed CKD&quot;, col = &quot;lightcoral&quot;)</code></pre>
<p><img src="case_study_AKI_files/figure-html/post-imputation-diagnostics-1.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Compare Region (categorical)
barplot(table(df$region, useNA = &quot;ifany&quot;), main = &quot;Original Region&quot;, col = &quot;lightblue&quot;)
barplot(table(df_imputed$region), main = &quot;Imputed Region&quot;, col = &quot;lightcoral&quot;)</code></pre>
<p><img src="case_study_AKI_files/figure-html/post-imputation-diagnostics-2.png" width="960" style="display: block; margin: auto;" /></p>
<pre class="r"><code>par(mfrow = c(1, 1))</code></pre>
</div>
<div id="save-the-imputed-dataset" class="section level2">
<h2>Save the imputed dataset</h2>
</div>
</div>
<div id="part-3-final-model-validation" class="section level1">
<h1>Part 3: Final Model Validation</h1>
<pre><code>## Summary of Key Metrics:</code></pre>
<pre><code>## --------------------</code></pre>
<pre><code>## Propensity score c-statistic: 0.593</code></pre>
<pre><code>## (Target from real data: ~0.60)</code></pre>
<pre><code>## Unadjusted HR: 1.36 ( 1.18 , 1.57 )</code></pre>
<pre><code>## (Target from real data: ~1.48, 95% CI: 1.32, 1.66)</code></pre>
<pre><code>## PS-matched HR: 1.18 ( 1.01 , 1.39 )</code></pre>
<pre><code>## (Target from real data: ~1.14, 95% CI: 1.00, 1.30)</code></pre>
<pre><code>## Overall event rate: 3.62 %</code></pre>
<pre><code>##                   Metric        Simulation         Real_Data
## 1         PS C-statistic             0.593              0.60
## 2 Unadjusted HR (95% CI) 1.36 (1.18, 1.57) 1.48 (1.32, 1.66)
## 3 PS-matched HR (95% CI) 1.18 (1.01, 1.39) 1.14 (1.00, 1.30)</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
