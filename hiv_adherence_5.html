<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrew Mertens">

<title>ART Comparison under Imperfect Adherence: Causal Roadmap + lmtp implementation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="hiv_adherence_5_files/libs/clipboard/clipboard.min.js"></script>
<script src="hiv_adherence_5_files/libs/quarto-html/quarto.js"></script>
<script src="hiv_adherence_5_files/libs/quarto-html/popper.min.js"></script>
<script src="hiv_adherence_5_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hiv_adherence_5_files/libs/quarto-html/anchor.min.js"></script>
<link href="hiv_adherence_5_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hiv_adherence_5_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hiv_adherence_5_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hiv_adherence_5_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hiv_adherence_5_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="hiv_adherence_5_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="hiv_adherence_5_files/libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#causal-roadmap-sap" id="toc-causal-roadmap-sap" class="nav-link" data-scroll-target="#causal-roadmap-sap">Causal Roadmap SAP</a>
  <ul class="collapse">
  <li><a href="#causal-question-formulation" id="toc-causal-question-formulation" class="nav-link" data-scroll-target="#causal-question-formulation">Causal Question Formulation</a></li>
  <li><a href="#target-populationeligibility-criteria" id="toc-target-populationeligibility-criteria" class="nav-link" data-scroll-target="#target-populationeligibility-criteria">Target Population/Eligibility Criteria</a></li>
  <li><a href="#time-zero-definition" id="toc-time-zero-definition" class="nav-link" data-scroll-target="#time-zero-definition">Time Zero Definition</a></li>
  <li><a href="#treatment-protocol-specification" id="toc-treatment-protocol-specification" class="nav-link" data-scroll-target="#treatment-protocol-specification">Treatment Protocol Specification</a></li>
  <li><a href="#outcome-definition" id="toc-outcome-definition" class="nav-link" data-scroll-target="#outcome-definition">Outcome Definition</a></li>
  <li><a href="#population-summary-specification" id="toc-population-summary-specification" class="nav-link" data-scroll-target="#population-summary-specification">Population Summary Specification</a></li>
  <li><a href="#ich-e9r1-primary-estimand-table-initiation-under-natural-care" id="toc-ich-e9r1-primary-estimand-table-initiation-under-natural-care" class="nav-link" data-scroll-target="#ich-e9r1-primary-estimand-table-initiation-under-natural-care">ICH E9(R1) Primary Estimand Table (Initiation Under Natural Care)</a></li>
  </ul></li>
  <li><a href="#simulation-with-pdc-adherence-monitoring-and-death" id="toc-simulation-with-pdc-adherence-monitoring-and-death" class="nav-link" data-scroll-target="#simulation-with-pdc-adherence-monitoring-and-death">Simulation with PDC adherence, monitoring, and death</a></li>
  <li><a href="#nodes-learners" id="toc-nodes-learners" class="nav-link" data-scroll-target="#nodes-learners">Nodes &amp; learners</a></li>
  <li><a href="#primary-analysis-initiation-under-natural-care-set-a1-only" id="toc-primary-analysis-initiation-under-natural-care-set-a1-only" class="nav-link" data-scroll-target="#primary-analysis-initiation-under-natural-care-set-a1-only">Primary analysis — Initiation under natural care (set A1 only)</a></li>
  <li><a href="#secondary-adherence-policy-gap-cap-lmtp-on-pdc" id="toc-secondary-adherence-policy-gap-cap-lmtp-on-pdc" class="nav-link" data-scroll-target="#secondary-adherence-policy-gap-cap-lmtp-on-pdc">Secondary — Adherence policy (Gap-cap LMTP on PDC)</a></li>
  <li><a href="#forgiveness-curves-ipsi-on-regimen-combined-plot" id="toc-forgiveness-curves-ipsi-on-regimen-combined-plot" class="nav-link" data-scroll-target="#forgiveness-curves-ipsi-on-regimen-combined-plot">Forgiveness curves — IPSI on regimen + combined plot</a></li>
  <li><a href="#operating-characteristics-mini-grid-biassecoverage" id="toc-operating-characteristics-mini-grid-biassecoverage" class="nav-link" data-scroll-target="#operating-characteristics-mini-grid-biassecoverage">Operating characteristics: mini grid (bias/SE/coverage)</a></li>
  <li><a href="#cox-illustration-only-not-the-estimand" id="toc-cox-illustration-only-not-the-estimand" class="nav-link" data-scroll-target="#cox-illustration-only-not-the-estimand">Cox (illustration only; not the estimand)</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ART Comparison under Imperfect Adherence: Causal Roadmap + lmtp implementation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Andrew Mertens </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>Antiretroviral therapy (ART) is highly effective for suppressing HIV, but in real-world settings imperfect adherence often complicates comparisons between drug regimens. Traditional approaches, such as Cox proportional hazards regression, are widely used to analyze time-to-event outcomes like virologic failure. However, Cox models have important limitations: they estimate hazard ratios that are difficult to interpret causally, they assume proportional hazards across time, and they are sensitive to model misspecification and informative censoring.</p>
<p>In this study we apply modern causal inference methods to estimate the effect of initiating Drug A versus Drug B on the risk of virologic failure at 12 and 36 months. We frame the analysis using the Causal Roadmap, specifying explicit inclusion criteria, treatment strategies, outcome definitions, and handling of intercurrent events. Using HealthVerity claims and laboratory data, we implement longitudinal modified treatment policy (LMTP) estimators and targeted maximum likelihood estimation (TMLE). These methods allow us to standardize adherence patterns, flexibly adjust for baseline and time-varying confounding with ensemble machine learning, and obtain risk differences and relative risks that are directly interpretable as causal contrasts.</p>
<p>By contrast with Cox regressions, our approach yields estimates that are doubly robust to model misspecification, less sensitive to non-proportional hazards, and accompanied by valid confidence intervals even under complex censoring. This analysis demonstrates how targeted learning provides a more transparent and reliable framework for comparative effectiveness research in HIV, strengthening the evidentiary value of real-world data for clinical and regulatory decision-making.</p>
</section>
<section id="causal-roadmap-sap" class="level1">
<h1>Causal Roadmap SAP</h1>
<section id="causal-question-formulation" class="level3">
<h3 class="anchored" data-anchor-id="causal-question-formulation">Causal Question Formulation</h3>
<p>Causal question: What is the causal effect of starting Drug A versus Drug B on virologic failure risk at 12 and 36 months, assuming both groups follow Drug A users’ adherence patterns? Population: Adults ≥18 years initiating first ART regimen (Drug A or B) with no prior ART in 365 days, baseline viral load measured within [-180,+30] days of initiation, laboratory linkage, pharmacy continuity, and ≥1 post-index viral load measurement. Excludes those with prior ART, pregnancy, missing demographics, no lab access, and optionally those with HBV contraindications.</p>
<p>Treatment: Starting Drug A and following observed real-world adherence pattern of Drug A users Comparator: Starting Drug B and following observed real-world adherence pattern of Drug A users (A-style adherence)</p>
<p>Outcome: Ever-virologic failure (VL ≥200) by 12 and 36 months (±30d windows); missing VL modeled via monitoring process. Risk differences: RD₁₂ = Risk₁₂(Drug A, A-adherence) - Risk₁₂(Drug B, A-adherence) and RD₃₆ = Risk₃₆(Drug A, A-adherence) - Risk₃₆(Drug B, A-adherence)</p>
<p>Data source: HealthVerity observational data with laboratory linkage and pharmacy continuity requirements</p>
</section>
<section id="target-populationeligibility-criteria" class="level3">
<h3 class="anchored" data-anchor-id="target-populationeligibility-criteria">Target Population/Eligibility Criteria</h3>
<p>Inclusion Criteria: * Adults ≥18 years at ART initiation * Confirmed HIV-1 infection: ≥2 HIV diagnosis codes on different dates (≥1 day apart), or ≥1 HIV diagnosis code plus HIV RNA lab evidence * Treatment-naïve new users: No combination ART regimens intended for HIV treatment in the 12 months prior to index * Index date = first observed prescription of Regimen A or Regimen B * Continuous medical + pharmacy enrollment for ≥12 months prior to index (baseline period) * Baseline labs available: HIV RNA and CD4 within −90 to +7 days of index * ≥1 post-baseline HIV RNA measurement observed during follow-up * Continuous enrollment for follow-up (up to 36 months or until censoring) Exclusion Criteria: * Prior ART exposure in baseline year or evidence of prior virologic failure (viral load &gt;200 copies/mL while on any prior ART) * Pregnancy at baseline * Chronic HBV co-infection * Severe renal impairment (eGFR &lt;30 mL/min/1.73m²) or severe hepatic impairment (Child-Pugh Class C) at baseline * Pediatric/adolescent patients (&lt;18 years) * No post-initiation viral load data (outcomes not observable) * Missing key demographics (sex, date of birth) * Active opportunistic infections at baseline requiring immediate treatment, or recent opportunistic infections (within 30-60 days) * Concurrent medications with major drug interactions per product labeling * Recent hospitalization for any reason within 30 days prior to index</p>
</section>
<section id="time-zero-definition" class="level3">
<h3 class="anchored" data-anchor-id="time-zero-definition">Time Zero Definition</h3>
<p>Participants will be enrolled at the first moment they meet all eligibility criteria within the Jan 2020–Jan 2025 recruitment window (incident eligibility). At enrollment, participants are randomized to Drug A or Drug B, which defines time zero; follow-up for virologic failure outcomes begins immediately at randomization.</p>
</section>
<section id="treatment-protocol-specification" class="level3">
<h3 class="anchored" data-anchor-id="treatment-protocol-specification">Treatment Protocol Specification</h3>
<p>Treatment strategy for the treatment arm: Participants start Drug A immediately at randomization (time zero) and remain on Drug A indefinitely throughout the follow-up period as the default plan. No specific discontinuation criteria are mandated by the protocol. Participants are allowed to switch to other HIV treatments under certain circumstances including treatment failure, toxicity, and physician discretion, with no restrictions on which alternative treatments may be selected. Temporary treatment interruptions are permitted without duration limits, with resumption decisions at physician discretion. Dose adjustments of Drug A are permitted as clinically indicated. Additional HIV medications may be added alongside Drug A when clinically appropriate.</p>
<p>Treatment strategy for the comparator arm: Participants start Drug B immediately at randomization (time zero) and follow an identical treatment strategy to the Drug A arm in all respects. They remain on Drug B indefinitely as the default plan, with the same allowances for switching, interruptions, dose adjustments, and additional medications under the same clinical circumstances and physician discretion.</p>
<p>Strategy to address treatment non-adherence: * Choice: HYPOTHETICAL STANDARDIZED ADHERENCE * ICH E9(R1) mapping: HYPOTHETICAL * Interpretation: Evaluates the comparative effectiveness of Drug A versus Drug B under the hypothetical scenario where both treatment groups follow identical adherence patterns (rather than their naturally observed adherence behaviors). This approach isolates the drugs’ intrinsic effectiveness by removing adherence differences as a confounding factor, while still allowing imperfect adherence to occur. The causal question becomes: “What is the comparative effectiveness of Drug A versus Drug B if both groups followed the same adherence pattern?”</p>
</section>
<section id="outcome-definition" class="level3">
<h3 class="anchored" data-anchor-id="outcome-definition">Outcome Definition</h3>
<ul>
<li>Primary outcome definition: Time from ART initiation to confirmed virologic failure, where confirmed virologic failure is defined as: (1) two consecutive viral load results ≥200 copies/mL at least 7 days apart, OR (2) one viral load ≥200 copies/mL followed by regimen change within 90 days. Cumulative incidence (risk) will be evaluated at 12 months and 36 months post-initiation.</li>
<li>Primary outcome type: Time-to-event</li>
<li>Additional outcome 1 definition: Time from ART initiation to switching from the index regimen to the other study regimen (i.e., Drug A participants switching to Drug B, or Drug B participants switching to Drug A)</li>
<li>Additional outcome 1 type: Time-to-event</li>
<li>Administrative end of follow-up: 36 months For the additional outcome (time to switching regimens), I choose: Death from any cause: Hypothetical intervention (ICH “hypothetical” strategy) Interpretation: “What would switching rates be if death were prevented?” This maintains consistency with our primary outcome approach and aligns with the research question of understanding treatment switching patterns in the absence of competing mortality. Disenrollment/data loss and Administrative end of follow-up (36 months): Hypothetical intervention (ICH “hypothetical” strategy) This approach provides a coherent analytical framework across all outcomes, focusing on the biological effects of the interventions while removing the influence of intercurrent events that could obscure the treatment comparison.</li>
</ul>
</section>
<section id="population-summary-specification" class="level3">
<h3 class="anchored" data-anchor-id="population-summary-specification">Population Summary Specification</h3>
<p>Primary outcome definition:</p>
<p>Time from ART initiation to confirmed virologic failure, with cumulative incidence evaluated at 12 months and 36 months post-initiation * Population summary of interest: Risk difference at 12 months and 36 months Additional outcome 1 definition: Time from ART initiation to switching from the index regimen to the other study regimen * Population summary of interest: Risk difference at 12 months and 36 months To summarize: you are studying the effect of initiating Drug A versus Drug B on virologic failure risk among adults with HIV-1 infection using HealthVerity observational data with laboratory linkage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core estimation &amp; ML</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(lmtp)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(SuperLearner)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data handling &amp; viz</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(purrr); <span class="fu">library</span>(tibble)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggplot2); <span class="fu">library</span>(broom)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># optional: Cox illustration</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(survival)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ich-e9r1-primary-estimand-table-initiation-under-natural-care" class="level2">
<h2 class="anchored" data-anchor-id="ich-e9r1-primary-estimand-table-initiation-under-natural-care">ICH E9(R1) Primary Estimand Table (Initiation Under Natural Care)</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>ICH E9(R1) attribute</th>
<th>Primary estimand specification</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Population</strong></td>
<td>Adults (≥18y) with confirmed HIV-1 initiating <strong>new-user</strong> ART (Drug A or Drug B) in HealthVerity; continuous medical + pharmacy enrollment ≥12 months pre-index; baseline VL &amp; CD4 within −90 to +7 days; ≥1 post-index VL; continuous enrollment until outcome or censoring.</td>
</tr>
<tr class="even">
<td><strong>Treatment (intervention)</strong></td>
<td><strong>Initiate Drug A at time zero</strong>; subsequent regimen changes, adherence, visits, and care follow the <strong>natural course</strong> (as observed).</td>
</tr>
<tr class="odd">
<td><strong>Treatment (comparator)</strong></td>
<td><strong>Initiate Drug B at time zero</strong>; subsequent course <strong>natural</strong> (as observed).</td>
</tr>
<tr class="even">
<td><strong>Variable (endpoint)</strong></td>
<td><strong>Confirmed virologic failure</strong> by 12 and 36 months (±30-day windows): 2 VL ≥200 copies/mL ≥7 days apart (primary). <em>Sensitivity:</em> 1 VL ≥200 + regimen change ≤90 days.</td>
</tr>
<tr class="odd">
<td><strong>Intercurrent events</strong></td>
<td><strong>Death:</strong> competing risk (primary). <strong>Switch/discontinuation:</strong> <strong>treatment-policy</strong> (failure counts regardless of changes). <strong>Disenrollment/data loss:</strong> right-censor; adjust with IPCW. <strong>Monitoring (VL ordering/attendance):</strong> model visit/ordering process; IPCW for monitoring. <strong>Administrative cutoff <span class="citation" data-cites="36m">@36m</span>:</strong> right-censor.</td>
</tr>
<tr class="even">
<td><strong>Summary measure</strong></td>
<td><strong>Risk difference</strong> (and supportive <strong>risk ratio</strong>) at 12 and 36 months: ( RD_t = P{Y(d^{=A})=1} - P{Y(d^{=B})=1}, &nbsp;t ).</td>
</tr>
<tr class="odd">
<td><strong>Time origin</strong></td>
<td>Index = first qualifying ART fill (A or B).</td>
</tr>
<tr class="even">
<td><strong>Identification assumptions</strong></td>
<td><strong>Consistency</strong>; <strong>sequential exchangeability</strong> (given baseline + time-varying covariates relevant for censoring/monitoring); <strong>positivity</strong> (support for initiating A/B and remaining observable); <strong>coarsening-at-random</strong> for censoring/monitoring.</td>
</tr>
<tr class="odd">
<td><strong>Estimation</strong></td>
<td><strong>LMTP/TMLE (or SDR)</strong> with <strong>Super Learner</strong> for outcome/censoring/monitoring; influence-curve SEs; diagnostics (EIF≈0, bounded risks, overlap checks). Cox HRs may be reported <strong>descriptively</strong> only.</td>
</tr>
<tr class="even">
<td><strong>Sensitivity analyses</strong></td>
<td>Endpoint threshold (≥400; single VL + switch); death as <strong>composite</strong> vs <strong>competing risk</strong>; monitoring window/rate assumptions; negative controls or E-/G-value style causal-gap analysis.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="simulation-with-pdc-adherence-monitoring-and-death" class="level1">
<h1>Simulation with PDC adherence, monitoring, and death</h1>
<p>We simulate realistic quarterly dynamics (K=4 ⇒ 12m): baseline risk, time-varying tolerability/adherence proxy L, PDC adherence, VL testing (monitoring), death (competing), disenrollment (censoring), switching, and a derived confirmed failure outcome that uses observed VLs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sim_hiv</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Quarterly DGP: PDC, monitoring, death, switching, confirmed failure</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sim_hiv <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">6000</span>L, <span class="at">K =</span> <span class="dv">4</span>L, <span class="at">seed =</span> <span class="dv">1</span>L) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Baseline</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  age  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">18</span>, <span class="fu">rnorm</span>(n, <span class="dv">42</span>, <span class="dv">10</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  male <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.55</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  cd4  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">20</span>, <span class="fu">rnorm</span>(n, <span class="dv">500</span>, <span class="dv">180</span>))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  vl0  <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(n, <span class="fu">log</span>(<span class="fl">1e5</span>), <span class="fl">0.7</span>)) <span class="co"># copies/mL</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># latent adherence propensity</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  eta_adher <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">scale</span>(cd4)[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span><span class="sc">*</span>(<span class="fu">log10</span>(vl0) <span class="sc">-</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>male <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.7</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># baseline proxy L1 and baseline regimen A1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  L1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(eta_adher <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.6</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  pA1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>male <span class="sc">-</span> <span class="fl">0.15</span><span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>L1)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  A1  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pA1)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># containers</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_integer_</span>, n, K); A[,<span class="dv">1</span>] <span class="ot">&lt;-</span> A1</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  PDC <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  L   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K); L[,<span class="dv">1</span>] <span class="ot">&lt;-</span> L1</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  C   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>L, n, K) <span class="co"># 1=uncensored</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  D   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>L, n, K) <span class="co"># death indicator per quarter</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  VLq <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  M   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>L, n, K) <span class="co"># testing indicator per quarter (monitoring)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hazards and VL dynamics</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  beta_A     <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  beta_logVL <span class="ot">&lt;-</span>  <span class="fl">0.35</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  beta_PDC   <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  beta_age   <span class="ot">&lt;-</span>  <span class="fl">0.12</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  logit_base_fail <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.6</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  logit_base_death <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.2</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  betaD_age <span class="ot">&lt;-</span> <span class="fl">0.20</span>; betaD_cd4 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span>; betaD_logVL <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># underlying log10 VL trajectory</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  log10VL <span class="ot">&lt;-</span> <span class="fu">log10</span>(vl0)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  monitor_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(log10VL_t, cd4, PDC_t) <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span>(log10VL_t<span class="fl">-4.5</span>) <span class="sc">-</span> <span class="fl">0.2</span><span class="sc">*</span>(cd4<span class="dv">-500</span>)<span class="sc">/</span><span class="dv">150</span> <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>(PDC_t<span class="fl">-0.7</span>))</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  fail_time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_integer_</span>, n)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  death_time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_integer_</span>, n)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PDC generation</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">==</span> <span class="dv">1</span>) base_adher <span class="ot">&lt;-</span> <span class="fu">plogis</span>(eta_adher <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>A[,<span class="dv">1</span>])</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&gt;=</span> <span class="dv">2</span>) base_adher <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fl">0.7</span><span class="sc">*</span><span class="fu">atan</span>(L[,k<span class="dv">-1</span>]) <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>A[,k] <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.3</span>))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    PDC[,k] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rbeta</span>(n, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">6</span><span class="sc">*</span>base_adher, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">6</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>base_adher)), <span class="fl">0.001</span>), <span class="fl">0.999</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VL transition (unobserved truth)</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    log10VL <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">2.0</span>, log10VL <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">-</span> <span class="fl">0.35</span><span class="sc">*</span>A[,k] <span class="sc">-</span> <span class="fl">0.6</span><span class="sc">*</span>(PDC[,k] <span class="sc">-</span> <span class="fl">0.6</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.25</span>))</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># monitoring and observed VL</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    M[,k] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">monitor_fun</span>(log10VL, cd4, PDC[,k]))</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    VLq[,k] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(M[,k]<span class="sc">==</span><span class="dv">1</span>, <span class="dv">10</span><span class="sc">^</span><span class="fu">rnorm</span>(n, <span class="at">mean=</span>log10VL, <span class="at">sd=</span><span class="fl">0.15</span>), <span class="cn">NA_real_</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># failure and death hazards</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    alive <span class="ot">&lt;-</span> <span class="fu">is.na</span>(death_time); notfailed <span class="ot">&lt;-</span> <span class="fu">is.na</span>(fail_time)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    p_fail <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_base_fail <span class="sc">+</span> beta_A<span class="sc">*</span>A[,k] <span class="sc">+</span> beta_logVL<span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">+</span> beta_PDC<span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>) <span class="sc">+</span> beta_age<span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    new_fail <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_fail) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> alive <span class="sc">&amp;</span> notfailed</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    fail_time[new_fail <span class="sc">&amp;</span> <span class="fu">is.na</span>(fail_time)] <span class="ot">&lt;-</span> k</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    p_death <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_base_death <span class="sc">+</span> betaD_age<span class="sc">*</span>(age<span class="dv">-50</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> betaD_cd4<span class="sc">*</span>(<span class="dv">500</span><span class="sc">-</span>cd4)<span class="sc">/</span><span class="dv">150</span> <span class="sc">+</span> betaD_logVL<span class="sc">*</span>(log10VL<span class="dv">-4</span>))</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    new_death <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_death) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> alive</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    D[new_death, k] <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    death_time[new_death <span class="sc">&amp;</span> <span class="fu">is.na</span>(death_time)] <span class="ot">&lt;-</span> k</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(new_death)) {</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">which</span>(new_death)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      C[idx, k<span class="sc">:</span>K] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># disenrollment/LTFU</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    p_cens <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">-</span> <span class="fl">0.3</span><span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>))</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    new_cens <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_cens) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (C[,k]<span class="sc">==</span><span class="dv">1</span>L) <span class="sc">&amp;</span> alive</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(new_cens)) {</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>      i <span class="ot">&lt;-</span> <span class="fu">which</span>(new_cens); C[i, k<span class="sc">:</span>K] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update L and switching</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&lt;</span> K) {</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(n, <span class="fl">0.2</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">-</span> <span class="fl">0.4</span><span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.4</span>), <span class="fl">0.7</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      logit_pA_next <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">*</span>A[,k] <span class="sc">-</span> <span class="fl">0.8</span><span class="sc">*</span>(L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="sc">&gt;</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="fl">0.25</span><span class="sc">*</span>L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      A[,k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(logit_pA_next))</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Confirmed failure from observed VLs: two observed VL ≥200 on &gt;=2 distinct quarters</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  highVL <span class="ot">&lt;-</span> (VLq <span class="sc">&gt;=</span> <span class="dv">200</span>) <span class="sc">&amp;</span> (<span class="sc">!</span><span class="fu">is.na</span>(VLq))</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  confirm_by_k <span class="ot">&lt;-</span> <span class="cf">function</span>(mat) {</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mat); K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mat)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    conf <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>L, n)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n)) {</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>      hits <span class="ot">&lt;-</span> <span class="fu">which</span>(mat[i,])</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(hits) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">diff</span>(hits) <span class="sc">&gt;=</span> <span class="dv">1</span>)) conf[i] <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    conf</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  confirmed <span class="ot">&lt;-</span> <span class="fu">confirm_by_k</span>(highVL)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  Y12 <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(confirmed <span class="sc">==</span> <span class="dv">1</span>L <span class="sc">&amp;</span> C[,K]<span class="sc">==</span><span class="dv">1</span>L)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    age, male, cd4, vl0,</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1 =</span> L[,<span class="dv">1</span>], <span class="at">A1 =</span> A[,<span class="dv">1</span>], <span class="at">PDC1 =</span> PDC[,<span class="dv">1</span>], <span class="at">M1 =</span> M[,<span class="dv">1</span>],</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2 =</span> L[,<span class="dv">2</span>], <span class="at">A2 =</span> A[,<span class="dv">2</span>], <span class="at">PDC2 =</span> PDC[,<span class="dv">2</span>], <span class="at">M2 =</span> M[,<span class="dv">2</span>],</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3 =</span> L[,<span class="dv">3</span>], <span class="at">A3 =</span> A[,<span class="dv">3</span>], <span class="at">PDC3 =</span> PDC[,<span class="dv">3</span>], <span class="at">M3 =</span> M[,<span class="dv">3</span>],</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">L4 =</span> L[,<span class="dv">4</span>], <span class="at">A4 =</span> A[,<span class="dv">4</span>], <span class="at">PDC4 =</span> PDC[,<span class="dv">4</span>], <span class="at">M4 =</span> M[,<span class="dv">4</span>],</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">C1 =</span> C[,<span class="dv">1</span>], <span class="at">C2 =</span> C[,<span class="dv">2</span>], <span class="at">C3 =</span> C[,<span class="dv">3</span>], <span class="at">C4 =</span> C[,<span class="dv">4</span>],</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">D1 =</span> D[,<span class="dv">1</span>], <span class="at">D2 =</span> D[,<span class="dv">2</span>], <span class="at">D3 =</span> D[,<span class="dv">3</span>], <span class="at">D4 =</span> D[,<span class="dv">4</span>],</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y  =</span> Y12</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_hiv</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="nodes-learners" class="level1">
<h1>Nodes &amp; learners</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">grep</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="fu">names</span>(dat))); <span class="fu">stopifnot</span>(K <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>trt_nodes  <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>, <span class="dv">1</span><span class="sc">:</span>K)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>baseline   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"male"</span>,<span class="st">"cd4"</span>,<span class="st">"vl0"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>time_vary  <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"PDC1"</span>,<span class="st">"M1"</span>), <span class="fu">c</span>(<span class="st">"L2"</span>,<span class="st">"PDC2"</span>,<span class="st">"M2"</span>), <span class="fu">c</span>(<span class="st">"L3"</span>,<span class="st">"PDC3"</span>,<span class="st">"M3"</span>), <span class="fu">c</span>(<span class="st">"L4"</span>,<span class="st">"PDC4"</span>,<span class="st">"M4"</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>cens_nodes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"C"</span>, <span class="dv">1</span><span class="sc">:</span>K)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>outcome    <span class="ot">&lt;-</span> <span class="st">"Y"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># modest/fast for demonstration; expand in later (trees/boosting/GAM/HAL) and increase folds for rare events</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>sl_lib <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="primary-analysis-initiation-under-natural-care-set-a1-only" class="level1">
<h1>Primary analysis — Initiation under natural care (set A1 only)</h1>
<p>These are policy/shift functions that tell {lmtp} how to modify the treatment history for a counterfactual analysis:</p>
<ul>
<li><p>d_initiate_A: set the baseline regimen A1 to 1 (“initiate Drug A”), and leave all later A2..AK as observed (natural course).</p></li>
<li><p>d_initiate_B: same but set A1 to 0 (“initiate Drug B”), leaving the rest natural.</p></li>
</ul>
<p>This is exactly the “initiation under natural care” estimand: we only intervene at baseline and then let adherence, switching, and monitoring evolve as in the observed data.</p>
<p><code>{lmtp_tmle}</code> estimates policy risk E{Y(d)} via TMLE for each shift:</p>
<p>trt = trt_nodes is the vector c(“A1”,“A2”,…,“AK”), i.e., the treatment nodes at each decision time.</p>
<p>baseline = baseline lists baseline covariates W.</p>
<p>time_vary = time_vary is a list of time-varying covariates L_t aligned by time (e.g., list(c(“L1”), c(“L2”),…)).</p>
<p>cens = cens_nodes gives interval censoring indicators (C1..CK, where 1 = uncensored through that interval).</p>
<p>outcome_type = “binomial” means the outcome Y is a fixed-horizon binary (e.g., failure by 12 months).</p>
<p>learners_trt, learners_outcome define the Super Learner libraries used to model treatment/censoring and outcome nuisances.</p>
<p>folds = cross-validation folds; 2 is fast for demos; use 5+ for stability in real runs.</p>
<p>fitA is the estimated risk if everyone were assigned A1 := 1 (Drug A) at baseline; fitB is the analogous risk for A1 := 0 (Drug B).</p>
<p>Now we run the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d_initiate_A <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">1</span>L, data[[trt]])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>d_initiate_B <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">0</span>L, data[[trt]])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>fitA <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat, <span class="at">trt =</span> trt_nodes, <span class="at">outcome =</span> outcome,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline =</span> baseline, <span class="at">time_vary =</span> time_vary, <span class="at">cens =</span> cens_nodes,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift =</span> d_initiate_A, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>fitB <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat, <span class="at">trt =</span> trt_nodes, <span class="at">outcome =</span> outcome,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline =</span> baseline, <span class="at">time_vary =</span> time_vary, <span class="at">cens =</span> cens_nodes,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift =</span> d_initiate_B, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>rd_init <span class="ot">&lt;-</span> <span class="fu">lmtp_contrast</span>(fitA, <span class="at">ref =</span> fitB, <span class="at">type =</span> <span class="st">"additive"</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>rr_init <span class="ot">&lt;-</span> <span class="fu">lmtp_contrast</span>(fitA, <span class="at">ref =</span> fitB, <span class="at">type =</span> <span class="st">"rr"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>rd_init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>::: {.cell-output .cell-output-stdout}</p>
<pre><code>
  shift   ref estimate std.error conf.low conf.high p.value
1 0.697 0.733   -0.036    0.0221  -0.0793   0.00722   0.103</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rr_init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>::: {.cell-output .cell-output-stdout}</p>
<pre><code>
  shift   ref estimate std.error conf.low conf.high p.value
1 0.697 0.733    0.951    0.0295    0.893      1.01  &lt;0.001</code></pre>
<p>::: :::</p>
</section>
<section id="secondary-adherence-policy-gap-cap-lmtp-on-pdc" class="level1">
<h1>Secondary — Adherence policy (Gap-cap LMTP on PDC)</h1>
<p>PDC (proportion of days covered) is a measure of how regularly someone fills their HIV medicine — a number between 0 and 1 (0 = never picked up pills, 1 = always had pills). In the simulated data, the continuous PDC has been turned into bins (for example: 0–10%, 10–20%, …, 90–100%). That’s the “discretized PDC.”</p>
<p>The gap-cap policy is a hypothetical rule that says: no one is allowed to have coverage lower than a threshold (say 80%). If a patient’s PDC in a given time period was 30%, the policy would “bump” them up to the lowest bin that represents at least 80%. If they already had ≥80% PDC, their value stays the same.</p>
<p>By applying this policy in the LMTP framework, the model is asking: “What would the 12-month risk of virologic failure be if, at every quarter, we intervened so that all patients had at least 80% adherence, compared with the risks we see under actual adherence patterns?”</p>
<p>So the output is an estimated risk under the gap-cap policy (and contrasts, if you compare it to natural adherence or between regimen groups).</p>
<p>We discretize because {lmtp} needs to model the treatment mechanism. That is simpler if PDC is represented as categories (bins) rather than as a raw continuous number — then we can use standard classification learners.</p>
<p>This differs from Cox regression because a Cox model would relate observed adherence to hazards of failure, assuming proportional hazards and correct model form, whereas the LMTP gap-cap analysis instead answers a policy question: “If everyone’s adherence were improved to at least 80%, what would the outcome distribution look like?” It uses targeted learning and machine learning to flexibly model confounders and treatment assignment, so the result is a causal risk difference under that policy, not just an association.</p>
<p>In short: the “gap-cap with discretized PDC” is estimating the effect of a hypothetical adherence-support intervention that prevents patients from ever dropping below 80% adherence, and then projecting how much that would change virologic failure risk at your chosen time points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># treat PDC nodes as trt; include regimen in time-varying covariates</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) Discretize PDC into ordered factors per quarter</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">12</span>)  <span class="co"># 11 bins</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>pdc_disc_nodes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PDCd"</span>, <span class="dv">1</span><span class="sc">:</span>K)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">as.numeric</span>(dat[[<span class="fu">paste0</span>(<span class="st">"PDC"</span>, k)]]), <span class="fl">1e-6</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-6</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  dat[[pdc_disc_nodes[k]]] <span class="ot">&lt;-</span> <span class="fu">cut</span>(v, <span class="at">breaks =</span> breaks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) Keep time-varying covariates as before (exclude discretized trt node itself)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>time_vary_pdc_disc <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>K, <span class="cf">function</span>(k) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"L"</span>, k), <span class="fu">paste0</span>(<span class="st">"A"</span>, k))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  vars[vars <span class="sc">%in%</span> <span class="fu">names</span>(dat)]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 3) Gap-cap shift for binned PDC: map the bin’s **lower edge** to floor at theta</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>cap_pdc_disc <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">theta =</span> <span class="fl">0.80</span>) {</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(theta)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(data, trt) {</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trt is factor; replace levels whose lower edge &lt; theta to the level whose lower edge &gt;= theta</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    levs <span class="ot">&lt;-</span> <span class="fu">levels</span>(data[[trt]])</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    lo   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">[(.*),.*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">[|</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, levs)))  <span class="co"># left edges</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find target level index</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    tgt  <span class="ot">&lt;-</span> <span class="fu">which</span>(lo <span class="sc">&gt;=</span> theta)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(tgt) <span class="sc">==</span> <span class="dv">0</span>) tgt <span class="ot">&lt;-</span> <span class="fu">length</span>(levs)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    tgt_level <span class="ot">&lt;-</span> levs[<span class="fu">min</span>(tgt)]</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># replace any level with left-edge &lt; theta by tgt_level</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(data[[trt]])</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    x[ lo[<span class="fu">match</span>(x, levs)] <span class="sc">&lt;</span> theta ] <span class="ot">&lt;-</span> tgt_level</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(x, <span class="at">levels =</span> levs)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 4) Fit with classification learners for trt and SL for outcome</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>sl_lib <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>fit_gapcap_disc <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">data        =</span> dat,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt         =</span> pdc_disc_nodes,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome     =</span> outcome,</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline    =</span> baseline,</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_vary   =</span> time_vary_pdc_disc,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">cens        =</span> cens_nodes,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift       =</span> <span class="fu">cap_pdc_disc</span>(<span class="fl">0.80</span>),</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_type     =</span> <span class="st">"binomial"</span>,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt     =</span> sl_lib,   <span class="co"># multinomial/ordinal via SL.glm / SL.glmnet</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_outcome =</span> sl_lib,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">folds       =</span> <span class="dv">2</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit_gapcap_disc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["estimate"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["conf.low"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["conf.high"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.6943103","2":"0.006597771","3":"0.681379","4":"0.7072417"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="forgiveness-curves-ipsi-on-regimen-combined-plot" class="level1">
<h1>Forgiveness curves — IPSI on regimen + combined plot</h1>
<p>We (i) compute policy risk under δ∈{0.75, 1.00, 1.25} separately for baseline initiators A1=1 vs A1=0 and (ii) overlay the primary initiation RD for visual context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: forgiveness</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># split on baseline regimen</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dat_A <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(A1 <span class="sc">==</span> <span class="dv">1</span>L)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>dat_B <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(A1 <span class="sc">==</span> <span class="dv">0</span>L)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>fit_ipsi_risk <span class="ot">&lt;-</span> <span class="cf">function</span>(data, delta, <span class="at">folds =</span> <span class="dv">2</span>) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lmtp_tmle</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">trt =</span> trt_nodes,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> outcome,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline =</span> baseline,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_vary =</span> time_vary,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">cens =</span> cens_nodes,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">shift =</span> <span class="fu">ipsi</span>(delta),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">folds =</span> folds</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">delta =</span> delta) <span class="sc">|&gt;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(delta, estimate, std.error, conf.low, conf.high)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>deltas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">1.00</span>, <span class="fl">1.25</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>risks <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(deltas, \(d) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_ipsi_risk</span>(dat_A, d) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"A1=1"</span>),</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_ipsi_risk</span>(dat_B, d) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"A1=0"</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>rd_delta <span class="ot">&lt;-</span> risks <span class="sc">|&gt;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(delta, group, estimate) <span class="sc">|&gt;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> group, <span class="at">values_from =</span> estimate) <span class="sc">|&gt;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RD =</span> <span class="st">`</span><span class="at">A1=1</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">A1=0</span><span class="st">`</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Lines for plotting</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>init_line <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> deltas,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">RD_init =</span> rd_init<span class="sc">$</span>estimate</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>p_forgive <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(risks, <span class="fu">aes</span>(<span class="at">x =</span> delta, <span class="at">y =</span> estimate, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> deltas) <span class="sc">+</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Forgiveness curves (IPSI on A_t) at 12 months"</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(delta<span class="sc">~</span><span class="st">"(odds multiplier for choosing A)"</span>),</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Policy risk under IPSI(δ)"</span>, <span class="at">color =</span> <span class="st">"Baseline regimen"</span>) <span class="sc">+</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>p_rd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(rd_delta, <span class="fu">aes</span>(<span class="at">x =</span> delta, <span class="at">y =</span> RD)) <span class="sc">+</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"grey60"</span>) <span class="sc">+</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#3B7EA1"</span>) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#3B7EA1"</span>) <span class="sc">+</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># overlay the initiation RD as a flat reference</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> rd_init<span class="sc">$</span>estimate<span class="sc">$</span>estimate, <span class="at">color =</span> <span class="st">"#990000"</span>, <span class="at">size =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">min</span>(deltas), <span class="at">y =</span> rd_init<span class="sc">$</span>estimate<span class="sc">$</span>estimate,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"Init RD = %.3f"</span>, rd_init<span class="sc">$</span>estimate<span class="sc">$</span>estimate),</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"#990000"</span>) <span class="sc">+</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> deltas) <span class="sc">+</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Between-regimen RD under IPSI(δ) vs initiation RD"</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(delta), <span class="at">y =</span> <span class="st">"RD(δ) = risk[A1=1,δ] − risk[A1=0,δ]"</span>) <span class="sc">+</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>p_forgive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hiv_adherence_5_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>p_rd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hiv_adherence_5_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="operating-characteristics-mini-grid-biassecoverage" class="level1">
<h1>Operating characteristics: mini grid (bias/SE/coverage)</h1>
<p>This grid varies baseline overlap, monitoring informativeness, and event frequency. It uses a quick Monte-Carlo “truth” per cell; scale up reps/grid for SAP-grade OC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>make_scenario <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">overlap =</span> <span class="fl">0.5</span>, <span class="at">monitor =</span> <span class="fl">0.5</span>, <span class="at">base_event =</span> <span class="sc">-</span><span class="fl">3.2</span>, <span class="at">n =</span> <span class="dv">3000</span>, <span class="at">K =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">1</span>L) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  age  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">45</span>, <span class="dv">10</span>); cd4 <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>, <span class="fu">rnorm</span>(n, <span class="dv">500</span>, <span class="dv">150</span>)); male <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.55</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  L1   <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  logit_pA1 <span class="ot">&lt;-</span> (<span class="dv">1-2</span><span class="sc">*</span>overlap)<span class="sc">*</span><span class="fl">0.8</span> <span class="sc">+</span> <span class="fl">0.25</span><span class="sc">*</span>male <span class="sc">-</span> <span class="fl">0.002</span><span class="sc">*</span>(cd4<span class="dv">-500</span>)<span class="sc">/</span><span class="dv">100</span> <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span>L1</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  A1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(logit_pA1))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  L <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K); L[,<span class="dv">1</span>] <span class="ot">&lt;-</span> L1</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_integer_</span>, n, K); A[,<span class="dv">1</span>] <span class="ot">&lt;-</span> A1</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>L, n, K)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  beta_A <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span>; beta_L <span class="ot">&lt;-</span> <span class="fl">0.6</span>; beta_W <span class="ot">&lt;-</span> <span class="fl">0.15</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  T_event <span class="ot">&lt;-</span> <span class="fu">rep</span>(K<span class="sc">+</span><span class="dv">1</span>L, n)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&gt;=</span> <span class="dv">2</span>) L[,k] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(n, <span class="fl">0.2</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>A[,k<span class="dv">-1</span>]) <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">plogis</span>(L[,k<span class="dv">-1</span>]), <span class="fl">0.8</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    lp <span class="ot">&lt;-</span> base_event <span class="sc">+</span> beta_A<span class="sc">*</span>A[,k] <span class="sc">+</span> beta_L<span class="sc">*</span>L[,k] <span class="sc">+</span> beta_W<span class="sc">*</span><span class="fu">scale</span>(age)[,<span class="dv">1</span>]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    new_event <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp)) <span class="sc">*</span> (T_event <span class="sc">&gt;</span> K)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    T_event[new_event <span class="sc">==</span> <span class="dv">1</span>L] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_event[new_event <span class="sc">==</span> <span class="dv">1</span>L], k)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    pcens <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> monitor<span class="sc">*</span>(<span class="fl">0.3</span><span class="sc">*</span><span class="fu">scale</span>(age)[,<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.25</span><span class="sc">*</span>L[,k]))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    cens_k <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pcens) <span class="sc">*</span> (<span class="fu">rowSums</span>(C, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">==</span> k<span class="dv">-1</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(cens_k <span class="sc">==</span> <span class="dv">1</span>L)) { i <span class="ot">&lt;-</span> <span class="fu">which</span>(cens_k <span class="sc">==</span> <span class="dv">1</span>L); C[i, k<span class="sc">:</span>K] <span class="ot">&lt;-</span> <span class="dv">0</span>L }</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&lt;</span> K) {</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>      logit_pA_next <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">*</span>A[,k] <span class="sc">-</span> <span class="fl">0.9</span><span class="sc">*</span>(L[,k] <span class="sc">&gt;</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>L[,k]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>      A[,k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(logit_pA_next))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">as.integer</span>((T_event <span class="sc">&lt;=</span> K) <span class="sc">&amp;</span> (C[,K] <span class="sc">==</span> <span class="dv">1</span>L))</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">age=</span>age, <span class="at">cd4=</span>cd4, <span class="at">male=</span>male,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1=</span>L[,<span class="dv">1</span>], <span class="at">A1=</span>A[,<span class="dv">1</span>], <span class="at">L2=</span>L[,<span class="dv">2</span>], <span class="at">A2=</span>A[,<span class="dv">2</span>],</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3=</span>L[,<span class="dv">3</span>], <span class="at">A3=</span>A[,<span class="dv">3</span>], <span class="at">L4=</span>L[,<span class="dv">4</span>], <span class="at">A4=</span>A[,<span class="dv">4</span>],</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">C1=</span>C[,<span class="dv">1</span>], <span class="at">C2=</span>C[,<span class="dv">2</span>], <span class="at">C3=</span>C[,<span class="dv">3</span>], <span class="at">C4=</span>C[,<span class="dv">4</span>],</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y=</span>Y</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>one_rep <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  trt_nodes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  baseline  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"cd4"</span>,<span class="st">"male"</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  time_vary <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"L1"</span>), <span class="fu">c</span>(<span class="st">"L2"</span>), <span class="fu">c</span>(<span class="st">"L3"</span>), <span class="fu">c</span>(<span class="st">"L4"</span>))</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  cens_nodes<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"C"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  outcome   <span class="ot">&lt;-</span> <span class="st">"Y"</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  sl_lib    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.glmnet"</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  dA <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">1</span>L, data[[trt]])</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  dB <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">0</span>L, data[[trt]])</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  fA <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(dat, trt_nodes, outcome, baseline, time_vary, cens_nodes,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shift =</span> dA, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>, <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  fB <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(dat, trt_nodes, outcome, baseline, time_vary, cens_nodes,</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shift =</span> dB, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>, <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">lmtp_contrast</span>(fA, <span class="at">ref =</span> fB, <span class="at">type =</span> <span class="st">"additive"</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">est =</span> con<span class="sc">$</span>estimate, <span class="at">se =</span> con<span class="sc">$</span>std.error, <span class="at">lo =</span> con<span class="sc">$</span>conf.low, <span class="at">hi =</span> con<span class="sc">$</span>conf.high)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>run_grid <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">reps =</span> <span class="dv">100</span>, <span class="at">n =</span> <span class="dv">2500</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">overlap_vals =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.5</span>),</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">monitor_vals =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>),</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">baseEv_vals  =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.6</span>, <span class="sc">-</span><span class="fl">3.2</span>)) {</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  truth_of <span class="ot">&lt;-</span> <span class="cf">function</span>(overlap, monitor, baseEv) {</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    big <span class="ot">&lt;-</span> <span class="fu">make_scenario</span>(overlap, monitor, baseEv, <span class="at">n =</span> <span class="dv">200000</span>, <span class="at">seed =</span> <span class="dv">777</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    trt_nodes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    baseline  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"cd4"</span>,<span class="st">"male"</span>)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    time_vary <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"L1"</span>), <span class="fu">c</span>(<span class="st">"L2"</span>), <span class="fu">c</span>(<span class="st">"L3"</span>), <span class="fu">c</span>(<span class="st">"L4"</span>))</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    cens_nodes<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"C"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    outcome   <span class="ot">&lt;-</span> <span class="st">"Y"</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    sl_lib    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.glmnet"</span>)</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    dA <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">1</span>L, data[[trt]])</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    dB <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) <span class="fu">ifelse</span>(trt <span class="sc">==</span> <span class="st">"A1"</span>, <span class="dv">0</span>L, data[[trt]])</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    fA <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(big, trt_nodes, outcome, baseline, time_vary, cens_nodes,</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shift =</span> dA, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>, <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    fB <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(big, trt_nodes, outcome, baseline, time_vary, cens_nodes,</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shift =</span> dB, <span class="at">outcome_type =</span> <span class="st">"binomial"</span>, <span class="at">learners_trt =</span> sl_lib, <span class="at">learners_outcome =</span> sl_lib, <span class="at">folds =</span> <span class="dv">2</span>)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lmtp_contrast</span>(fA, <span class="at">ref =</span> fB, <span class="at">type =</span> <span class="st">"additive"</span>)<span class="sc">$</span>estimate</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">overlap =</span> overlap_vals, <span class="at">monitor =</span> monitor_vals, <span class="at">baseEv =</span> baseEv_vals) <span class="sc">|&gt;</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">true_RD =</span> <span class="fu">pmap_dbl</span>(<span class="fu">list</span>(overlap, monitor, baseEv), truth_of))</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">res =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(overlap, monitor, baseEv), <span class="cf">function</span>(ov, mo, be){</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replicate</span>(reps, {</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>        dat <span class="ot">&lt;-</span> <span class="fu">make_scenario</span>(ov, mo, be, <span class="at">n =</span> n, <span class="at">seed =</span> <span class="fu">sample.int</span>(<span class="fl">1e7</span>, <span class="dv">1</span>))</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">one_rep</span>(dat)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>(<span class="at">.name_repair =</span> <span class="st">"minimal"</span>) <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"est"</span>,<span class="st">"se"</span>,<span class="st">"lo"</span>,<span class="st">"hi"</span>))</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    })) <span class="sc">%&gt;%</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(res) <span class="sc">%&gt;%</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(overlap, monitor, baseEv, true_RD) <span class="sc">%&gt;%</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean_est =</span> <span class="fu">mean</span>(est),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>              <span class="at">mc_se    =</span> <span class="fu">sd</span>(est),</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>              <span class="at">bias     =</span> <span class="fu">mean</span>(est <span class="sc">-</span> true_RD),</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>              <span class="at">cover    =</span> <span class="fu">mean</span>(lo <span class="sc">&lt;=</span> true_RD <span class="sc">&amp;</span> hi <span class="sc">&gt;=</span> true_RD),</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  results</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Small run (increase reps / cells in SAP)</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>grid_summ <span class="ot">&lt;-</span> <span class="fu">run_grid</span>(<span class="at">reps =</span> <span class="dv">5</span>, <span class="at">n =</span> <span class="dv">1000</span>)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>grid_summ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cox-illustration-only-not-the-estimand" class="level1">
<h1>Cox (illustration only; not the estimand)</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox-illustration</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build start-stop data if Y1..YK not present; otherwise adapt</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">grep</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="fu">names</span>(dat)))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>datC <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">matches</span>(<span class="st">"^([ALCYDM]</span><span class="sc">\\</span><span class="st">d+)$"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>,<span class="st">"t"</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_pattern =</span> <span class="st">"([A-Z]+)(</span><span class="sc">\\</span><span class="st">d+)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">as.integer</span>(t),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">start =</span> t<span class="dv">-1</span>L, <span class="at">stop =</span> t) <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, t) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">4</span> <span class="sc">&amp;</span> Y <span class="sc">==</span> <span class="dv">1</span>L, <span class="dv">1</span>L, <span class="dv">0</span>L)) <span class="sc">%&gt;%</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(start, stop, event) <span class="sc">~</span> A <span class="sc">+</span> L <span class="sc">+</span> age <span class="sc">+</span> cd4 <span class="sc">+</span> male, <span class="at">data =</span> datC)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(start, stop, event) ~ A + L + age + cd4 + 
    male, data = datC)

  n= 24000, number of events= 3363 

           coef  exp(coef)   se(coef)       z Pr(&gt;|z|)    
A    -2.499e-02  9.753e-01  3.501e-02  -0.714  0.47534    
L     2.050e-02  1.021e+00  2.129e-02   0.963  0.33559    
age  -5.075e-03  9.949e-01  1.708e-03  -2.972  0.00296 ** 
cd4  -1.360e-03  9.986e-01  9.929e-05 -13.700  &lt; 2e-16 ***
male -6.044e-02  9.413e-01  3.465e-02  -1.744  0.08110 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
A       0.9753     1.0253    0.9106    1.0446
L       1.0207     0.9797    0.9790    1.0642
age     0.9949     1.0051    0.9916    0.9983
cd4     0.9986     1.0014    0.9984    0.9988
male    0.9413     1.0623    0.8795    1.0075

Concordance= 0.606  (se = 0.007 )
Likelihood ratio test= 203.2  on 5 df,   p=&lt;2e-16
Wald test            = 201.8  on 5 df,   p=&lt;2e-16
Score (logrank) test = 202  on 5 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>