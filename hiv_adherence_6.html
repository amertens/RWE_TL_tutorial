<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrew Mertens">

<title>ART Comparison under Imperfect Adherence: Causal Roadmap + lmtp implementation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="hiv_adherence_6_files/libs/clipboard/clipboard.min.js"></script>
<script src="hiv_adherence_6_files/libs/quarto-html/quarto.js"></script>
<script src="hiv_adherence_6_files/libs/quarto-html/popper.min.js"></script>
<script src="hiv_adherence_6_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hiv_adherence_6_files/libs/quarto-html/anchor.min.js"></script>
<link href="hiv_adherence_6_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hiv_adherence_6_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hiv_adherence_6_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hiv_adherence_6_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hiv_adherence_6_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="hiv_adherence_6_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="hiv_adherence_6_files/libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#causal-roadmap-sap" id="toc-causal-roadmap-sap" class="nav-link" data-scroll-target="#causal-roadmap-sap">Causal Roadmap SAP</a>
  <ul class="collapse">
  <li><a href="#causal-question-formulation" id="toc-causal-question-formulation" class="nav-link" data-scroll-target="#causal-question-formulation">Causal Question Formulation</a></li>
  <li><a href="#target-populationeligibility-criteria" id="toc-target-populationeligibility-criteria" class="nav-link" data-scroll-target="#target-populationeligibility-criteria">Target Population/Eligibility Criteria</a></li>
  <li><a href="#time-zero-definition" id="toc-time-zero-definition" class="nav-link" data-scroll-target="#time-zero-definition">Time Zero Definition</a></li>
  <li><a href="#treatment-protocol-specification" id="toc-treatment-protocol-specification" class="nav-link" data-scroll-target="#treatment-protocol-specification">Treatment Protocol Specification</a></li>
  <li><a href="#outcome-definition" id="toc-outcome-definition" class="nav-link" data-scroll-target="#outcome-definition">Outcome Definition</a></li>
  <li><a href="#population-summary-specification" id="toc-population-summary-specification" class="nav-link" data-scroll-target="#population-summary-specification">Population Summary Specification</a></li>
  <li><a href="#ich-e9r1-primary-estimand-table-initiation-under-natural-care" id="toc-ich-e9r1-primary-estimand-table-initiation-under-natural-care" class="nav-link" data-scroll-target="#ich-e9r1-primary-estimand-table-initiation-under-natural-care">ICH E9(R1) Primary Estimand Table (Initiation Under Natural Care)</a></li>
  </ul></li>
  <li><a href="#simulation-with-pdc-adherence-monitoring-and-death" id="toc-simulation-with-pdc-adherence-monitoring-and-death" class="nav-link" data-scroll-target="#simulation-with-pdc-adherence-monitoring-and-death">Simulation with PDC adherence, monitoring, and death</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ART Comparison under Imperfect Adherence: Causal Roadmap + lmtp implementation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Andrew Mertens </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>Antiretroviral therapy (ART) is highly effective for suppressing HIV, but in real-world settings imperfect adherence often complicates comparisons between drug regimens. Traditional approaches, such as Cox proportional hazards regression, are widely used to analyze time-to-event outcomes like virologic failure. However, Cox models have important limitations: they estimate hazard ratios that are difficult to interpret causally, they assume proportional hazards across time, and they are sensitive to model misspecification and informative censoring.</p>
<p>In this study we apply modern causal inference methods to estimate the effect of initiating Drug A versus Drug B on the risk of virologic failure at 12 and 36 months. We frame the analysis using the Causal Roadmap, specifying explicit inclusion criteria, treatment strategies, outcome definitions, and handling of intercurrent events. Using HealthVerity claims and laboratory data, we implement longitudinal modified treatment policy (LMTP) estimators and targeted maximum likelihood estimation (TMLE). These methods allow us to standardize adherence patterns, flexibly adjust for baseline and time-varying confounding with ensemble machine learning, and obtain risk differences and relative risks that are directly interpretable as causal contrasts.</p>
<p>By contrast with Cox regressions, our approach yields estimates that are doubly robust to model misspecification, less sensitive to non-proportional hazards, and accompanied by valid confidence intervals even under complex censoring. This analysis demonstrates how targeted learning provides a more transparent and reliable framework for comparative effectiveness research in HIV, strengthening the evidentiary value of real-world data for clinical and regulatory decision-making.</p>
</section>
<section id="causal-roadmap-sap" class="level1">
<h1>Causal Roadmap SAP</h1>
<section id="causal-question-formulation" class="level3">
<h3 class="anchored" data-anchor-id="causal-question-formulation">Causal Question Formulation</h3>
<p>Causal question: What is the causal effect of starting Drug A versus Drug B on virologic failure risk at 12 and 36 months, assuming both groups follow Drug A users’ adherence patterns? Population: Adults ≥18 years initiating first ART regimen (Drug A or B) with no prior ART in 365 days, baseline viral load measured within [-180,+30] days of initiation, laboratory linkage, pharmacy continuity, and ≥1 post-index viral load measurement. Excludes those with prior ART, pregnancy, missing demographics, no lab access, and optionally those with HBV contraindications.</p>
<p>Treatment: Starting Drug A and following observed real-world adherence pattern of Drug A users Comparator: Starting Drug B and following observed real-world adherence pattern of Drug A users (A-style adherence)</p>
<p>Outcome: Ever-virologic failure (VL ≥200) by 12 and 36 months (±30d windows); missing VL modeled via monitoring process. Risk differences: RD₁₂ = Risk₁₂(Drug A, A-adherence) - Risk₁₂(Drug B, A-adherence) and RD₃₆ = Risk₃₆(Drug A, A-adherence) - Risk₃₆(Drug B, A-adherence)</p>
<p>Data source: HealthVerity observational data with laboratory linkage and pharmacy continuity requirements</p>
</section>
<section id="target-populationeligibility-criteria" class="level3">
<h3 class="anchored" data-anchor-id="target-populationeligibility-criteria">Target Population/Eligibility Criteria</h3>
<p>Inclusion Criteria: * Adults ≥18 years at ART initiation * Confirmed HIV-1 infection: ≥2 HIV diagnosis codes on different dates (≥1 day apart), or ≥1 HIV diagnosis code plus HIV RNA lab evidence * Treatment-naïve new users: No combination ART regimens intended for HIV treatment in the 12 months prior to index * Index date = first observed prescription of Regimen A or Regimen B * Continuous medical + pharmacy enrollment for ≥12 months prior to index (baseline period) * Baseline labs available: HIV RNA and CD4 within −90 to +7 days of index * ≥1 post-baseline HIV RNA measurement observed during follow-up * Continuous enrollment for follow-up (up to 36 months or until censoring) Exclusion Criteria: * Prior ART exposure in baseline year or evidence of prior virologic failure (viral load &gt;200 copies/mL while on any prior ART) * Pregnancy at baseline * Chronic HBV co-infection * Severe renal impairment (eGFR &lt;30 mL/min/1.73m²) or severe hepatic impairment (Child-Pugh Class C) at baseline * Pediatric/adolescent patients (&lt;18 years) * No post-initiation viral load data (outcomes not observable) * Missing key demographics (sex, date of birth) * Active opportunistic infections at baseline requiring immediate treatment, or recent opportunistic infections (within 30-60 days) * Concurrent medications with major drug interactions per product labeling * Recent hospitalization for any reason within 30 days prior to index</p>
</section>
<section id="time-zero-definition" class="level3">
<h3 class="anchored" data-anchor-id="time-zero-definition">Time Zero Definition</h3>
<p>Participants will be enrolled at the first moment they meet all eligibility criteria within the Jan 2020–Jan 2025 recruitment window (incident eligibility). At enrollment, participants are randomized to Drug A or Drug B, which defines time zero; follow-up for virologic failure outcomes begins immediately at randomization.</p>
</section>
<section id="treatment-protocol-specification" class="level3">
<h3 class="anchored" data-anchor-id="treatment-protocol-specification">Treatment Protocol Specification</h3>
<p>Treatment strategy for the treatment arm: Participants start Drug A immediately at randomization (time zero) and remain on Drug A indefinitely throughout the follow-up period as the default plan. No specific discontinuation criteria are mandated by the protocol. Participants are allowed to switch to other HIV treatments under certain circumstances including treatment failure, toxicity, and physician discretion, with no restrictions on which alternative treatments may be selected. Temporary treatment interruptions are permitted without duration limits, with resumption decisions at physician discretion. Dose adjustments of Drug A are permitted as clinically indicated. Additional HIV medications may be added alongside Drug A when clinically appropriate.</p>
<p>Treatment strategy for the comparator arm: Participants start Drug B immediately at randomization (time zero) and follow an identical treatment strategy to the Drug A arm in all respects. They remain on Drug B indefinitely as the default plan, with the same allowances for switching, interruptions, dose adjustments, and additional medications under the same clinical circumstances and physician discretion.</p>
<p>Strategy to address treatment non-adherence: * Choice: HYPOTHETICAL STANDARDIZED ADHERENCE * ICH E9(R1) mapping: HYPOTHETICAL * Interpretation: Evaluates the comparative effectiveness of Drug A versus Drug B under the hypothetical scenario where both treatment groups follow identical adherence patterns (rather than their naturally observed adherence behaviors). This approach isolates the drugs’ intrinsic effectiveness by removing adherence differences as a confounding factor, while still allowing imperfect adherence to occur. The causal question becomes: “What is the comparative effectiveness of Drug A versus Drug B if both groups followed the same adherence pattern?”</p>
</section>
<section id="outcome-definition" class="level3">
<h3 class="anchored" data-anchor-id="outcome-definition">Outcome Definition</h3>
<ul>
<li>Primary outcome definition: Time from ART initiation to confirmed virologic failure, where confirmed virologic failure is defined as: (1) two consecutive viral load results ≥200 copies/mL at least 7 days apart, OR (2) one viral load ≥200 copies/mL followed by regimen change within 90 days. Cumulative incidence (risk) will be evaluated at 12 months and 36 months post-initiation.</li>
<li>Primary outcome type: Time-to-event</li>
<li>Additional outcome 1 definition: Time from ART initiation to switching from the index regimen to the other study regimen (i.e., Drug A participants switching to Drug B, or Drug B participants switching to Drug A)</li>
<li>Additional outcome 1 type: Time-to-event</li>
<li>Administrative end of follow-up: 36 months For the additional outcome (time to switching regimens), I choose: Death from any cause: Hypothetical intervention (ICH “hypothetical” strategy) Interpretation: “What would switching rates be if death were prevented?” This maintains consistency with our primary outcome approach and aligns with the research question of understanding treatment switching patterns in the absence of competing mortality. Disenrollment/data loss and Administrative end of follow-up (36 months): Hypothetical intervention (ICH “hypothetical” strategy) This approach provides a coherent analytical framework across all outcomes, focusing on the biological effects of the interventions while removing the influence of intercurrent events that could obscure the treatment comparison.</li>
</ul>
</section>
<section id="population-summary-specification" class="level3">
<h3 class="anchored" data-anchor-id="population-summary-specification">Population Summary Specification</h3>
<p>Primary outcome definition:</p>
<p>Time from ART initiation to confirmed virologic failure, with cumulative incidence evaluated at 12 months and 36 months post-initiation * Population summary of interest: Risk difference at 12 months and 36 months Additional outcome 1 definition: Time from ART initiation to switching from the index regimen to the other study regimen * Population summary of interest: Risk difference at 12 months and 36 months To summarize: you are studying the effect of initiating Drug A versus Drug B on virologic failure risk among adults with HIV-1 infection using HealthVerity observational data with laboratory linkage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core estimation &amp; ML</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(lmtp)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(SuperLearner)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data handling &amp; viz</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(purrr); <span class="fu">library</span>(tibble)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggplot2); <span class="fu">library</span>(broom)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># optional: Cox illustration</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(survival)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ich-e9r1-primary-estimand-table-initiation-under-natural-care" class="level2">
<h2 class="anchored" data-anchor-id="ich-e9r1-primary-estimand-table-initiation-under-natural-care">ICH E9(R1) Primary Estimand Table (Initiation Under Natural Care)</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>ICH E9(R1) attribute</th>
<th>Primary estimand specification</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Population</strong></td>
<td>Adults (≥18y) with confirmed HIV-1 initiating <strong>new-user</strong> ART (Drug A or Drug B) in HealthVerity; continuous medical + pharmacy enrollment ≥12 months pre-index; baseline VL &amp; CD4 within −90 to +7 days; ≥1 post-index VL; continuous enrollment until outcome or censoring.</td>
</tr>
<tr class="even">
<td><strong>Treatment (intervention)</strong></td>
<td><strong>Initiate Drug A at time zero</strong>; subsequent regimen changes, adherence, visits, and care follow the <strong>natural course</strong> (as observed).</td>
</tr>
<tr class="odd">
<td><strong>Treatment (comparator)</strong></td>
<td><strong>Initiate Drug B at time zero</strong>; subsequent course <strong>natural</strong> (as observed).</td>
</tr>
<tr class="even">
<td><strong>Variable (endpoint)</strong></td>
<td><strong>Confirmed virologic failure</strong> by 12 and 36 months (±30-day windows): 2 VL ≥200 copies/mL ≥7 days apart (primary). <em>Sensitivity:</em> 1 VL ≥200 + regimen change ≤90 days.</td>
</tr>
<tr class="odd">
<td><strong>Intercurrent events</strong></td>
<td><strong>Death:</strong> competing risk (primary). <strong>Switch/discontinuation:</strong> <strong>treatment-policy</strong> (failure counts regardless of changes). <strong>Disenrollment/data loss:</strong> right-censor; adjust with IPCW. <strong>Monitoring (VL ordering/attendance):</strong> model visit/ordering process; IPCW for monitoring. <strong>Administrative cutoff <span class="citation" data-cites="36m">@36m</span>:</strong> right-censor.</td>
</tr>
<tr class="even">
<td><strong>Summary measure</strong></td>
<td><strong>Risk difference</strong> (and supportive <strong>risk ratio</strong>) at 12 and 36 months: ( RD_t = P{Y(d^{=A})=1} - P{Y(d^{=B})=1}, &nbsp;t ).</td>
</tr>
<tr class="odd">
<td><strong>Time origin</strong></td>
<td>Index = first qualifying ART fill (A or B).</td>
</tr>
<tr class="even">
<td><strong>Identification assumptions</strong></td>
<td><strong>Consistency</strong>; <strong>sequential exchangeability</strong> (given baseline + time-varying covariates relevant for censoring/monitoring); <strong>positivity</strong> (support for initiating A/B and remaining observable); <strong>coarsening-at-random</strong> for censoring/monitoring.</td>
</tr>
<tr class="odd">
<td><strong>Estimation</strong></td>
<td><strong>LMTP/TMLE (or SDR)</strong> with <strong>Super Learner</strong> for outcome/censoring/monitoring; influence-curve SEs; diagnostics (EIF≈0, bounded risks, overlap checks). Cox HRs may be reported <strong>descriptively</strong> only.</td>
</tr>
<tr class="even">
<td><strong>Sensitivity analyses</strong></td>
<td>Endpoint threshold (≥400; single VL + switch); death as <strong>composite</strong> vs <strong>competing risk</strong>; monitoring window/rate assumptions; negative controls or E-/G-value style causal-gap analysis.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="simulation-with-pdc-adherence-monitoring-and-death" class="level1">
<h1>Simulation with PDC adherence, monitoring, and death</h1>
<p>We simulate realistic quarterly dynamics (K=4 ⇒ 12m): baseline risk, time-varying tolerability/adherence proxy L, PDC adherence, VL testing (monitoring), death (competing), disenrollment (censoring), switching, and a derived confirmed failure outcome that uses observed VLs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sim_hiv</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Quarterly DGP: PDC, monitoring, death, switching, confirmed failure</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sim_hiv <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">6000</span>L, <span class="at">K =</span> <span class="dv">4</span>L, <span class="at">seed =</span> <span class="dv">1</span>L) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Baseline</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  age  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">18</span>, <span class="fu">rnorm</span>(n, <span class="dv">42</span>, <span class="dv">10</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  male <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.55</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  cd4  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">20</span>, <span class="fu">rnorm</span>(n, <span class="dv">500</span>, <span class="dv">180</span>))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  vl0  <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(n, <span class="fu">log</span>(<span class="fl">1e5</span>), <span class="fl">0.7</span>)) <span class="co"># copies/mL</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># latent adherence propensity</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  eta_adher <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">scale</span>(cd4)[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span><span class="sc">*</span>(<span class="fu">log10</span>(vl0) <span class="sc">-</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>male <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.7</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># baseline proxy L1 and baseline regimen A1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  L1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(eta_adher <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.6</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  pA1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>male <span class="sc">-</span> <span class="fl">0.15</span><span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>L1)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  A1  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pA1)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># containers</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_integer_</span>, n, K); A[,<span class="dv">1</span>] <span class="ot">&lt;-</span> A1</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  PDC <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  L   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K); L[,<span class="dv">1</span>] <span class="ot">&lt;-</span> L1</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  C   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>L, n, K) <span class="co"># 1=uncensored</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  D   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>L, n, K) <span class="co"># death indicator per quarter</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  VLq <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, n, K)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  M   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>L, n, K) <span class="co"># testing indicator per quarter (monitoring)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hazards and VL dynamics</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  beta_A     <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  beta_logVL <span class="ot">&lt;-</span>  <span class="fl">0.35</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  beta_PDC   <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  beta_age   <span class="ot">&lt;-</span>  <span class="fl">0.12</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  logit_base_fail <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.6</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  logit_base_death <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.2</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  betaD_age <span class="ot">&lt;-</span> <span class="fl">0.20</span>; betaD_cd4 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span>; betaD_logVL <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># underlying log10 VL trajectory</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  log10VL <span class="ot">&lt;-</span> <span class="fu">log10</span>(vl0)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  monitor_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(log10VL_t, cd4, PDC_t) <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span>(log10VL_t<span class="fl">-4.5</span>) <span class="sc">-</span> <span class="fl">0.2</span><span class="sc">*</span>(cd4<span class="dv">-500</span>)<span class="sc">/</span><span class="dv">150</span> <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>(PDC_t<span class="fl">-0.7</span>))</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  fail_time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_integer_</span>, n)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  death_time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_integer_</span>, n)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PDC generation</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">==</span> <span class="dv">1</span>) base_adher <span class="ot">&lt;-</span> <span class="fu">plogis</span>(eta_adher <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>A[,<span class="dv">1</span>])</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&gt;=</span> <span class="dv">2</span>) base_adher <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fl">0.7</span><span class="sc">*</span><span class="fu">atan</span>(L[,k<span class="dv">-1</span>]) <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>A[,k] <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.3</span>))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    PDC[,k] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rbeta</span>(n, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">6</span><span class="sc">*</span>base_adher, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">6</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>base_adher)), <span class="fl">0.001</span>), <span class="fl">0.999</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VL transition (unobserved truth)</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    log10VL <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">2.0</span>, log10VL <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">-</span> <span class="fl">0.35</span><span class="sc">*</span>A[,k] <span class="sc">-</span> <span class="fl">0.6</span><span class="sc">*</span>(PDC[,k] <span class="sc">-</span> <span class="fl">0.6</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.25</span>))</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># monitoring and observed VL</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    M[,k] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">monitor_fun</span>(log10VL, cd4, PDC[,k]))</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    VLq[,k] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(M[,k]<span class="sc">==</span><span class="dv">1</span>, <span class="dv">10</span><span class="sc">^</span><span class="fu">rnorm</span>(n, <span class="at">mean=</span>log10VL, <span class="at">sd=</span><span class="fl">0.15</span>), <span class="cn">NA_real_</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># failure and death hazards</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    alive <span class="ot">&lt;-</span> <span class="fu">is.na</span>(death_time); notfailed <span class="ot">&lt;-</span> <span class="fu">is.na</span>(fail_time)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    p_fail <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_base_fail <span class="sc">+</span> beta_A<span class="sc">*</span>A[,k] <span class="sc">+</span> beta_logVL<span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">+</span> beta_PDC<span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>) <span class="sc">+</span> beta_age<span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    new_fail <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_fail) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> alive <span class="sc">&amp;</span> notfailed</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    fail_time[new_fail <span class="sc">&amp;</span> <span class="fu">is.na</span>(fail_time)] <span class="ot">&lt;-</span> k</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    p_death <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_base_death <span class="sc">+</span> betaD_age<span class="sc">*</span>(age<span class="dv">-50</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> betaD_cd4<span class="sc">*</span>(<span class="dv">500</span><span class="sc">-</span>cd4)<span class="sc">/</span><span class="dv">150</span> <span class="sc">+</span> betaD_logVL<span class="sc">*</span>(log10VL<span class="dv">-4</span>))</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    new_death <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_death) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> alive</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    D[new_death, k] <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    death_time[new_death <span class="sc">&amp;</span> <span class="fu">is.na</span>(death_time)] <span class="ot">&lt;-</span> k</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(new_death)) {</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">which</span>(new_death)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      C[idx, k<span class="sc">:</span>K] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># disenrollment/LTFU</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    p_cens <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>(age<span class="dv">-45</span>)<span class="sc">/</span><span class="dv">10</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">-</span> <span class="fl">0.3</span><span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>))</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    new_cens <span class="ot">&lt;-</span> (<span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_cens) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (C[,k]<span class="sc">==</span><span class="dv">1</span>L) <span class="sc">&amp;</span> alive</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(new_cens)) {</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>      i <span class="ot">&lt;-</span> <span class="fu">which</span>(new_cens); C[i, k<span class="sc">:</span>K] <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update L and switching</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (k <span class="sc">&lt;</span> K) {</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(n, <span class="fl">0.2</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>) <span class="sc">-</span> <span class="fl">0.4</span><span class="sc">*</span>(PDC[,k]<span class="sc">-</span><span class="fl">0.6</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="fl">0.4</span>), <span class="fl">0.7</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      logit_pA_next <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">*</span>A[,k] <span class="sc">-</span> <span class="fl">0.8</span><span class="sc">*</span>(L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="sc">&gt;</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="fl">0.25</span><span class="sc">*</span>L[,k<span class="sc">+</span><span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>(log10VL<span class="dv">-4</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      A[,k<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(logit_pA_next))</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Confirmed failure from observed VLs: two observed VL ≥200 on &gt;=2 distinct quarters</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>  highVL <span class="ot">&lt;-</span> (VLq <span class="sc">&gt;=</span> <span class="dv">200</span>) <span class="sc">&amp;</span> (<span class="sc">!</span><span class="fu">is.na</span>(VLq))</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  confirm_by_k <span class="ot">&lt;-</span> <span class="cf">function</span>(mat) {</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mat); K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mat)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    conf <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>L, n)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n)) {</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>      hits <span class="ot">&lt;-</span> <span class="fu">which</span>(mat[i,])</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(hits) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">diff</span>(hits) <span class="sc">&gt;=</span> <span class="dv">1</span>)) conf[i] <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    conf</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  confirmed <span class="ot">&lt;-</span> <span class="fu">confirm_by_k</span>(highVL)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  Y12 <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(confirmed <span class="sc">==</span> <span class="dv">1</span>L <span class="sc">&amp;</span> C[,K]<span class="sc">==</span><span class="dv">1</span>L)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    age, male, cd4, vl0,</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1 =</span> L[,<span class="dv">1</span>], <span class="at">A1 =</span> A[,<span class="dv">1</span>], <span class="at">PDC1 =</span> PDC[,<span class="dv">1</span>], <span class="at">M1 =</span> M[,<span class="dv">1</span>],</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2 =</span> L[,<span class="dv">2</span>], <span class="at">A2 =</span> A[,<span class="dv">2</span>], <span class="at">PDC2 =</span> PDC[,<span class="dv">2</span>], <span class="at">M2 =</span> M[,<span class="dv">2</span>],</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3 =</span> L[,<span class="dv">3</span>], <span class="at">A3 =</span> A[,<span class="dv">3</span>], <span class="at">PDC3 =</span> PDC[,<span class="dv">3</span>], <span class="at">M3 =</span> M[,<span class="dv">3</span>],</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">L4 =</span> L[,<span class="dv">4</span>], <span class="at">A4 =</span> A[,<span class="dv">4</span>], <span class="at">PDC4 =</span> PDC[,<span class="dv">4</span>], <span class="at">M4 =</span> M[,<span class="dv">4</span>],</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">C1 =</span> C[,<span class="dv">1</span>], <span class="at">C2 =</span> C[,<span class="dv">2</span>], <span class="at">C3 =</span> C[,<span class="dv">3</span>], <span class="at">C4 =</span> C[,<span class="dv">4</span>],</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">D1 =</span> D[,<span class="dv">1</span>], <span class="at">D2 =</span> D[,<span class="dv">2</span>], <span class="at">D3 =</span> D[,<span class="dv">3</span>], <span class="at">D4 =</span> D[,<span class="dv">4</span>],</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y  =</span> Y12</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_hiv</span>()</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["age"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["male"],"name":[2],"type":["int"],"align":["right"]},{"label":["cd4"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["vl0"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["L1"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["A1"],"name":[6],"type":["int"],"align":["right"]},{"label":["PDC1"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["M1"],"name":[8],"type":["int"],"align":["right"]},{"label":["L2"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["A2"],"name":[10],"type":["int"],"align":["right"]},{"label":["PDC2"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["M2"],"name":[12],"type":["int"],"align":["right"]},{"label":["L3"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["A3"],"name":[14],"type":["int"],"align":["right"]},{"label":["PDC3"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["M3"],"name":[16],"type":["int"],"align":["right"]},{"label":["L4"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["A4"],"name":[18],"type":["int"],"align":["right"]},{"label":["PDC4"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["M4"],"name":[20],"type":["int"],"align":["right"]},{"label":["C1"],"name":[21],"type":["int"],"align":["right"]},{"label":["C2"],"name":[22],"type":["int"],"align":["right"]},{"label":["C3"],"name":[23],"type":["int"],"align":["right"]},{"label":["C4"],"name":[24],"type":["int"],"align":["right"]},{"label":["D1"],"name":[25],"type":["int"],"align":["right"]},{"label":["D2"],"name":[26],"type":["int"],"align":["right"]},{"label":["D3"],"name":[27],"type":["int"],"align":["right"]},{"label":["D4"],"name":[28],"type":["int"],"align":["right"]},{"label":["Y"],"name":[29],"type":["int"],"align":["right"]}],"data":[{"1":"35.73546","2":"1","3":"280.9184","4":"86093.50","5":"0.3833783","6":"1","7":"0.2527592","8":"0","9":"0.3622649","10":"0","11":"0.6590305","12":"1","13":"1.2559277","14":"0","15":"0.7467723","16":"1","17":"0.1263760","18":"1","19":"0.8336735","20":"0","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"1","_rn_":"1"},{"1":"43.83643","2":"1","3":"329.6787","4":"92801.60","5":"-1.9216929","6":"0","7":"0.1108615","8":"1","9":"1.0490344","10":"1","11":"0.5694791","12":"0","13":"1.1106306","14":"1","15":"0.5864964","16":"0","17":"1.1853238","18":"0","19":"0.6114681","20":"0","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"0","_rn_":"2"},{"1":"33.64371","2":"1","3":"516.4538","4":"72237.38","5":"0.5259706","6":"0","7":"0.6883548","8":"0","9":"-0.4569555","10":"1","11":"0.5665311","12":"0","13":"1.6780069","14":"0","15":"0.2921980","16":"1","17":"0.3316342","18":"0","19":"0.6808240","20":"1","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"1","_rn_":"3"},{"1":"57.95281","2":"0","3":"626.2432","4":"61940.82","5":"3.0000000","6":"1","7":"0.7939258","8":"1","9":"-0.1774607","10":"1","11":"0.7235467","12":"1","13":"1.3146859","14":"0","15":"0.4052004","16":"0","17":"-0.9783410","18":"1","19":"0.5838293","20":"1","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"1","_rn_":"4"},{"1":"45.29508","2":"1","3":"621.2160","4":"57489.92","5":"1.4941129","6":"1","7":"0.5145395","8":"1","9":"0.2973596","10":"0","11":"0.5174053","12":"1","13":"1.5768379","14":"0","15":"0.4876549","16":"1","17":"-0.5249554","18":"0","19":"0.5989152","20":"1","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"1","_rn_":"5"},{"1":"33.79532","2":"0","3":"727.7996","4":"78877.46","5":"1.2105919","6":"1","7":"0.8673682","8":"1","9":"-0.9876193","10":"1","11":"0.7521805","12":"1","13":"0.5997168","14":"1","15":"0.3455744","16":"0","17":"0.2276058","18":"1","19":"0.3720660","20":"0","21":"1","22":"1","23":"1","24":"1","25":"0","26":"0","27":"0","28":"0","29":"1","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>