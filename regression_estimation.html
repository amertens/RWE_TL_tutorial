<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>HCV → AKI: 90‑Day Primary &amp; Sensitivity Analyses</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">HOME</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="RWE_tutorial.html">Introduction: TL Roadmap in RWE</a>
</li>
<li>
  <a href="step0.html">Causal roadmap and case study introduction</a>
</li>
<li>
  <a href="step1v2.html">Roadmap step 1-alt</a>
</li>
<li>
  <a href="step1a.html">Roadmap step 1a</a>
</li>
<li>
  <a href="step1b.html">Roadmap step 1b</a>
</li>
<li>
  <a href="step2.html">Roadmap step 2</a>
</li>
<li>
  <a href="step3.html">Roadmap step 3</a>
</li>
<li>
  <a href="step4.html">Roadmap step 4</a>
</li>
<li>
  <a href="step5.html">Roadmap step 5</a>
</li>
<li>
  <a href="PS_analysis.html">Propensity score matching analysis</a>
</li>
<li>
  <a href="appendix.html">Appendix</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">HCV → AKI: 90‑Day Primary &amp; Sensitivity
Analyses</h1>

</div>

<div id="TOC">
true
</div>

<blockquote>
<p><strong>Purpose.</strong> Estimate the 90‑day cumulative risk of
first acute kidney injury (AKI) comparing (A = 1) sofosbuvir‑containing
vs (A = 0) non‑sofosbuvir DAA regimens <strong>under a hypothetical
<em>no‑switch</em> intervention</strong> (primary estimand,
IPCW‑adjusted) and contrast it with two routinely reported
sensitivities:</p>
<p>* <strong>Treatment‑policy ITT</strong> – ignores
switching/discontinuation. * <strong>Naïve as‑treated</strong> – censors
30 d after the first regimen switch (no weighting).</p>
</blockquote>
<p>The simulated claims‑style dataset (_sim_hcv_aki_complex.csv) was
generated with <code>DGP.R</code>.</p>
<hr />
<p>## 1 Setup</p>
<p>## 2 Load &amp; tidy the data</p>
<pre class="r"><code>df &lt;- read_csv(here(&quot;data/sim_hcv_aki_complex.csv&quot;), show_col_types = FALSE) %&gt;%
  mutate(
    # key analysis variables
    time       = follow_time,          # already min(event, censor)
    event      = event,                # 1 = AKI, 0 = censored
    trt        = treatment,            # 1 = SOF, 0 = non‑SOF
    switched   = switch               # 1 if regimen switch occurred
  )

# restrict to ≤ 90 days for all estimands
cutoff &lt;- 90</code></pre>
<p>## 3 Primary estimand – IPCW <em>no‑switch</em>
(while‑on‑treatment)</p>
<p>### 3.1 Define analytic censoring indicator We artificially censor
each subject at <em>min</em>(first switch day + 30, administrative 90
d). All post‑censor events are treated as missing via weighting.</p>
<pre class="r"><code># administrative 90‑day horizon
admin_censor &lt;- if_else(df$time &gt; cutoff, 1, 0)
# switch‑based censoring (+30 d risk window simulated via DGP)
switch_censor &lt;- if_else(df$switched == 1 &amp; df$time &gt; 0, 1, 0)

# overall censoring indicator for IPCW model
C &lt;- pmax(admin_censor, switch_censor)   # 1 = censored before AKI
Tstar &lt;- pmin(df$time, cutoff)           # observed/administrative time

df_ipcw &lt;- df %&gt;% mutate(C = C, Tstar = Tstar, event_ipcw = if_else(event==1 &amp; time&lt;=cutoff &amp; C==0, 1, 0))</code></pre>
<p>### 3.2 Estimate censoring weights A simple pooled‑logistic
(discrete‑time) model conditional on baseline covariates suffices for
illustration; more flexible spline‑based models are easily
substituted.</p>
<pre class="r"><code># baseline covariates used in DGP
covars &lt;- c(&quot;age&quot;,&quot;ckd&quot;,&quot;cirrhosis&quot;,&quot;diabetes&quot;,&quot;bmi&quot;,&quot;sex_male&quot;)

# expand person‑day data up to censor/event/cutoff
expand_rows &lt;- function(dat){
  purrr::map_dfr(seq_len(nrow(dat)), function(i){
    tibble(id = dat$id[i], trt = dat$trt[i],
           day = seq_len(dat$Tstar[i]),
           censored = if_else(day == dat$Tstar[i] &amp; dat$C[i]==1,1,0),
           event    = if_else(day == dat$Tstar[i] &amp; dat$event_ipcw[i]==1,1,0),
           !!!dat[i, covars])
  })
}

long &lt;- expand_rows(df_ipcw)

# pooled‑logistic model for censoring.
fitC &lt;- glm(censored ~ trt + ns(day,4) + ., family = binomial(), data = long)
long &lt;- long %&gt;%
  mutate(pC = predict(fitC, type = &quot;response&quot;)) %&gt;%
  group_by(id) %&gt;%
  mutate(Surv_uncens = cumprod(1 - pC)) %&gt;% ungroup()

weights &lt;- long %&gt;% group_by(id) %&gt;% summarise(w = last(Surv_uncens))
df_ipcw &lt;- df_ipcw %&gt;% left_join(weights, by = &quot;id&quot;)
# truncate extreme weights (optional balance/stability)
df_ipcw &lt;- df_ipcw %&gt;% mutate(w = pmin(w, quantile(w, .995, na.rm=T)))</code></pre>
<p>### 3.3 Weighted Kaplan–Meier &amp; risk estimates</p>
<pre class="r"><code>km_ipcw &lt;- survfit(Surv(Tstar, event_ipcw) ~ trt, data = df_ipcw, weights = w)

# extract 90‑day survival &amp; compute risks
surv_90 &lt;- summary(km_ipcw, times = cutoff)$surv
risk_90 &lt;- 1 - surv_90
risk_tbl &lt;- tibble(trt = c(&quot;non‑SOF&quot;,&quot;SOF&quot;), risk = risk_90)

risk_tbl</code></pre>
<pre><code>## # A tibble: 2 × 2
##   trt      risk
##   &lt;chr&gt;   &lt;dbl&gt;
## 1 non‑SOF 0.176
## 2 SOF     0.303</code></pre>
<pre class="r"><code>risk_diff &lt;- diff(rev(risk_90))   # SOF – non‑SOF</code></pre>
<p>## 4 Sensitivity 1 – Treatment‑policy ITT (ignore switch)</p>
<pre class="r"><code>km_itt &lt;- survfit(Surv(pmin(time, cutoff), event) ~ trt, data = df)
surv_90_itt &lt;- summary(km_itt, times = cutoff)$surv
risk_90_itt &lt;- 1 - surv_90_itt
diff_itt &lt;- diff(rev(risk_90_itt))</code></pre>
<p>## 5 Sensitivity 2 – Naive as‑treated (censor at switch, no
weighting)</p>
<pre class="r"><code># censor 30 d after switch as already in DGP (follow_time)
km_naive &lt;- survfit(Surv(pmin(time, cutoff), event) ~ trt, data = df_ipcw[df_ipcw$C==0 | df_ipcw$event_ipcw==1,])

risk_90_naive &lt;- 1 - summary(km_naive, times = cutoff, extend = TRUE)$surv
diff_naive &lt;- diff(rev(risk_90_naive))</code></pre>
<p>## 6 Results summary</p>
<pre class="r"><code>res &lt;- tibble(
  Estimand = c(&quot;Primary: IPCW no‑switch&quot;,&quot;Sensitivity: ITT&quot;,&quot;Sensitivity: naïve as‑treated&quot;),
  Risk_nonSOF = c(risk_90[1], risk_90_itt[1], risk_90_naive[1]),
  Risk_SOF    = c(risk_90[2], risk_90_itt[2], risk_90_naive[2]),
  Risk_Diff   = c(risk_diff, diff_itt, diff_naive)
)
knitr::kable(res, digits = 3, caption = &quot;90‑day cumulative risk of first AKI&quot;)</code></pre>
<table>
<caption>90‑day cumulative risk of first AKI</caption>
<thead>
<tr class="header">
<th align="left">Estimand</th>
<th align="right">Risk_nonSOF</th>
<th align="right">Risk_SOF</th>
<th align="right">Risk_Diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Primary: IPCW no‑switch</td>
<td align="right">0.176</td>
<td align="right">0.303</td>
<td align="right">-0.128</td>
</tr>
<tr class="even">
<td align="left">Sensitivity: ITT</td>
<td align="right">0.058</td>
<td align="right">0.120</td>
<td align="right">-0.062</td>
</tr>
<tr class="odd">
<td align="left">Sensitivity: naïve as‑treated</td>
<td align="right">0.268</td>
<td align="right">0.403</td>
<td align="right">-0.135</td>
</tr>
</tbody>
</table>
<p><strong>Interpretation.</strong> The IPCW‑adjusted <em>no‑switch</em>
analysis isolates the biologic effect of continuous SOF exposure,
whereas ITT represents the real‑world initiation policy, and the naïve
censor‑at‑switch gives an upper‑bound that may be biased if switching is
informative.</p>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
