<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Your Team" />

<meta name="date" content="2025-09-08" />

<title>Comparing ART Regimens Under Imperfect Adherence with {lmtp}: A Causal Roadmap Tutorial</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">HOME</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="RWE_tutorial.html">Introduction: TL Roadmap in RWE</a>
</li>
<li>
  <a href="step0.html">Causal roadmap and case study introduction</a>
</li>
<li>
  <a href="step1v2.html">Roadmap step 1-alt</a>
</li>
<li>
  <a href="step1a.html">Roadmap step 1a</a>
</li>
<li>
  <a href="step1b.html">Roadmap step 1b</a>
</li>
<li>
  <a href="step2.html">Roadmap step 2</a>
</li>
<li>
  <a href="step3.html">Roadmap step 3</a>
</li>
<li>
  <a href="step4.html">Roadmap step 4</a>
</li>
<li>
  <a href="step5.html">Roadmap step 5</a>
</li>
<li>
  <a href="PS_analysis.html">Propensity score matching analysis</a>
</li>
<li>
  <a href="appendix.html">Appendix</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Comparing ART Regimens Under Imperfect
Adherence with {lmtp}: A Causal Roadmap Tutorial</h1>
<h4 class="author">Your Team</h4>
<h4 class="date">2025-09-08</h4>

</div>


<div
id="causal-roadmap-for-safety-comparison-of-two-art-regimens-under-imperfect-adherence"
class="section level1" number="1">
<h1><span class="header-section-number">1</span> Causal Roadmap for:
Safety Comparison of Two ART Regimens Under Imperfect Adherence</h1>
<div
id="define-the-precise-causal-question-scientific-and-decision-relevant"
class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> 1) Define the precise
causal question (scientific and decision-relevant)</h2>
<p>We seek to quantify how the risk of an adverse safety endpoint (e.g.,
AKI or composite safety event) differs between two clinically relevant
first-line ART regimens when <em>real-world adherence is imperfect</em>.
Rather than conditioning on perfect adherence (often clinically
unrealistic), we target <em>modified treatment policies (MTPs)</em> that
perturb adherence intensity—via incremental propensity score
interventions (IPSI)—by multiplicative factors δ∈{0.75, 1.00, 1.25}
separately for each regimen. The primary decision-relevant contrast is
the between-regimen difference (or ratio) in cumulative risk by
clinically meaningful times (e.g., 12, 24, 36, 48 weeks) under each δ,
thereby characterizing <em>“forgiveness”</em>—i.e., the degree to which
safety risk deteriorates as adherence is stochastically reduced and
improves as it is increased.</p>
</div>
<div id="specify-the-idealized-interventions" class="section level2"
number="1.2">
<h2><span class="header-section-number">1.2</span> 2) Specify the
idealized interventions</h2>
<p>Let <span class="math inline">\(A_t\)</span> denote current regimen
at visit <span class="math inline">\(t\)</span> and <span
class="math inline">\(Z_t\)</span> denote observed adherence (e.g., PDC,
pill counts, pharmacy fills, or EHR adherence proxies). For each regimen
<span class="math inline">\(r\in\{R_0,R_1\}\)</span>, define an IPSI
that multiplies the observed adherence assignment odds by δ at each
time, preserving the observed covariate–adherence relationships but
shifting adherence intensity. This yields counterfactual adherence
trajectories <span class="math inline">\(\tilde Z^{(r,
\delta)}_{1:K}\)</span> and outcome <span
class="math inline">\(Y^{(r,\delta)}\)</span>. We also consider a
<em>dynamic regimen assignment at baseline</em> to <span
class="math inline">\(R_0\)</span> vs <span
class="math inline">\(R_1\)</span> with adherence subsequently perturbed
by the δ‑IPSI. These are <em>well-defined, feasible, and
policy-relevant</em> stochastic interventions for real-world use
cases.</p>
</div>
<div id="define-the-causal-estimands" class="section level2"
number="1.3">
<h2><span class="header-section-number">1.3</span> 3) Define the causal
estimands</h2>
<p>For time horizon <span class="math inline">\(t\)</span>, define the
regimen- and δ-specific cumulative risk: <span class="math display">\[
\psi_{r,\delta}(t) \equiv \Pr\!\big(Y^{(r,\delta)}\le t\big).
\]</span> Primary estimands include: - <strong>Between-regimen risk
difference at δ:</strong> <span
class="math inline">\(\psi_{R_1,\delta}(t)-\psi_{R_0,\delta}(t)\)</span>.
- <strong>Between-regimen risk ratio at δ:</strong> <span
class="math inline">\(\psi_{R_1,\delta}(t)/\psi_{R_0,\delta}(t)\)</span>.
- <strong>Forgiveness curve:</strong> <span
class="math inline">\(\delta\mapsto \psi_{r,\delta}(t)\)</span> for each
regimen, summarized by slope or area (e.g., finite differences across a
δ grid).</p>
<p>For time-to-event outcomes, these parameters are transparent,
collapsible, and align with estimand guidance emphasizing clinically
interpretable risks and survival probabilities rather than
noncollapsible hazards.</p>
</div>
<div id="link-data-to-counterfactuals-observed-data-structure"
class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> 4) Link data to
counterfactuals (observed data structure)</h2>
<p>Observed longitudinal data for each person <span
class="math inline">\(i\)</span>: baseline <span
class="math inline">\(W\)</span>; at visits <span
class="math inline">\(t=1,\dots,K\)</span>: time-varying covariates
<span class="math inline">\(L_t\)</span> (disease status, labs,
toxicity, concomitant meds), treatment <span
class="math inline">\(A_t\)</span> (here baseline regimen choice;
optionally allow switches), adherence <span
class="math inline">\(Z_t\)</span>, censoring <span
class="math inline">\(C_t\)</span>, and outcome time-to-event <span
class="math inline">\(T\)</span> with indicator <span
class="math inline">\(\Delta\)</span>. Write <span
class="math inline">\(O=(W,\{L_t,A_t,Z_t,C_t\}_{t\le
K},T,\Delta)\)</span>. The likelihood factorizes into conditional
hazards for the event, censoring, adherence, and (if relevant) regimen
switching.</p>
</div>
<div id="causal-identification-assumptions" class="section level2"
number="1.5">
<h2><span class="header-section-number">1.5</span> 5) Causal
identification assumptions</h2>
<p>Under standard longitudinal identification: -
<strong>Consistency:</strong> If a subject’s observed regimen/adherence
trajectory matches the intervention, then observed and counterfactual
outcomes coincide. - <strong>Sequential exchangeability (no unmeasured
confounding):</strong> Given <span class="math inline">\(W,\bar L_t,\bar
A_t,\bar Z_{t-1}\)</span>, adherence at <span
class="math inline">\(t\)</span> and censoring at <span
class="math inline">\(t\)</span> are as good as randomized relative to
future potential outcomes under the intervention. -
<strong>Positivity:</strong> Positive probability of observed adherence
and censoring patterns in all strata needed by the intervention, and
overlap in baseline regimen assignment support. - <strong>Correct
handling of intercurrent events:</strong> Switching, competing risks,
and loss-to-follow-up represented as hazards and included in
identification (see §9).</p>
<p>When these hold, the δ‑MTP/δ‑IPSI risks are identified by a
longitudinal g-formula integrating the observed conditional hazards with
the adherence mechanism replaced by the δ‑shifted stochastic policy.</p>
</div>
<div
id="estimation-strategy-targeted-doubly-robust-machine-learningfriendly"
class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> 6) Estimation
strategy (targeted, doubly robust, machine-learning–friendly)</h2>
<p>We will estimate <span
class="math inline">\(\psi_{r,\delta}(t)\)</span> using
<strong>longitudinal TMLE</strong> (or the <strong>lmtp</strong>
estimator for IPSI/MTPs), which: 1. Learns nuisance functions with
cross-validated Super Learner (SL) (e.g., outcome, adherence, censoring
hazards);<br />
2. <em>Targets</em> the plug-in estimate along a least-favorable
submodel to solve the efficient influence function, delivering valid
Wald inference under broad conditions;<br />
3. Provides <strong>double robustness</strong> and
<strong>efficiency</strong> under coarsening-at-random censoring and
flexible learning of hazards.</p>
<p>SL library design (GLMs, penalized GLMs, trees/forests/boosting, HAL)
and V-fold CV must follow best practices to control overfitting and
improve finite-sample behavior.</p>
</div>
<div id="working-model-components-and-sl-specification"
class="section level2" number="1.7">
<h2><span class="header-section-number">1.7</span> 7) Working model
components and SL specification</h2>
<ul>
<li><strong>Outcome model:</strong> discrete-time hazard (pooled
logistic) or survival hazards (discrete or continuous-time) regressed on
<span class="math inline">\(W,\bar L_t,\bar Z_t,\bar A_t\)</span>;
include sparse and flexible learners.</li>
<li><strong>Adherence mechanism:</strong> conditional density/propensity
of <span class="math inline">\(Z_t\)</span> given history, needed for
IPSI weighting/clever covariates; if <span
class="math inline">\(Z_t\)</span> is categorical/binary, model as
conditional odds; if continuous, use density-ratio learners supported by
<em>lmtp</em>.</li>
<li><strong>Censoring (and administrative loss):</strong> hazard <span
class="math inline">\(\lambda_C(t\mid \text{history})\)</span>.</li>
<li><strong>Regimen switching (if allowed):</strong> model hazard <span
class="math inline">\(\lambda_{S}(t\mid \text{history})\)</span> and
incorporate in identification/estimation (see §9).</li>
</ul>
</div>
<div id="inference-error-control-and-operating-characteristics"
class="section level2" number="1.8">
<h2><span class="header-section-number">1.8</span> 8) Inference, error
control, and operating characteristics</h2>
<p>TMLE/lmtp yields asymptotically linear estimators with
influence-curve–based standard errors; we will report pointwise 95% CIs
and, for trajectories <span
class="math inline">\(\delta\mapsto\psi_{r,\delta}(t)\)</span> or <span
class="math inline">\(t\mapsto\psi_{r,\delta}(t)\)</span>, simultaneous
bands where appropriate. Simulations in analogous right-censored
settings show that TMLE maintains nominal coverage and often improves
efficiency versus Kaplan–Meier and model-based G‑comp, especially under
informative censoring and moderate covariate predictiveness.</p>
</div>
<div id="intercurrent-events-competing-risks-and-switching"
class="section level2" number="1.9">
<h2><span class="header-section-number">1.9</span> 9) Intercurrent
events, competing risks, and switching</h2>
<ul>
<li><strong>Switching:</strong> Censor-at-switching can be informatively
biased. Prefer modeling the <strong>switching hazard</strong> and
incorporating it into the longitudinal identification, or expand the
intervention to <em>prevent switching</em> in the counterfactual while
estimating the switching process from data—then target the no-switch
estimand.</li>
<li><strong>Competing risks:</strong> When death (or other) competes
with the safety event, we target <strong>cause-specific cumulative
incidence</strong> (risk) under the δ‑policy and present both event-free
survival and cause-specific risks.</li>
<li><strong>Loss to follow-up:</strong> Treat as censoring with a
modeled hazard; identification requires coarsening-at-random given the
measured history.</li>
</ul>
</div>
<div id="why-not-cox-with-time-varying-covariates"
class="section level2" number="1.10">
<h2><span class="header-section-number">1.10</span> 10) Why not Cox with
time-varying covariates?</h2>
<p>Cox HRs are <strong>noncollapsible</strong> (adjustment changes the
estimand), hinge on proportional hazards, and condition on remaining at
risk (subject to selection), which can mislead about absolute
risks—especially with time-varying effects, informative censoring, and
regimen/adherence dynamics. In contrast, roadmap-based risks and risk
differences/ratios are collapsible and directly interpretable for
decision-making; TMLE provides robust estimation in large, nonparametric
models. We therefore present Cox only as a <strong>secondary,
model-based</strong> sensitivity analysis, not as the primary
estimand.</p>
</div>
<div id="diagnostics-and-model-free-checks" class="section level2"
number="1.11">
<h2><span class="header-section-number">1.11</span> 11) Diagnostics and
model-free checks</h2>
<ul>
<li><strong>Design diagnostics:</strong> Examine overlap/positivity
(propensity of baseline regimen; adherence support across δ‑relevant
strata); assess near‑violations (truncation thresholds, stabilized
clever covariates).<br />
</li>
<li><strong>Learner diagnostics:</strong> Cross‑validated risks, SL
weights, and sensitivity to library composition; adjust V‑folds in
small‑event contexts.<br />
</li>
<li><strong>Targeting diagnostics:</strong> Empirical mean of the
efficient influence function close to 0; bounded, monotone survival/risk
curves.<br />
</li>
<li><strong>Sensitivity to unmeasured confounding:</strong> E‑values or
bias‑function sensitivity, including sensitivity to MNAR censoring and
to measurement error in adherence.</li>
</ul>
</div>
<div id="missing-data-and-measurement-error" class="section level2"
number="1.12">
<h2><span class="header-section-number">1.12</span> 12) Missing data and
measurement error</h2>
<ul>
<li><strong>Covariates:</strong> Use missingness indicators or multiple
imputation nested within CV (preferably outcome‑blind steps within CV
folds).<br />
</li>
<li><strong>Adherence measurement error:</strong> If adherence is an
error‑prone proxy (PDC), consider SIMEX‑type sensitivity, validation
sub‑studies, or replicate‑measure approaches; report how measurement
error could attenuate the forgiveness curves.</li>
</ul>
</div>
<div id="reporting" class="section level2" number="1.13">
<h2><span class="header-section-number">1.13</span> 13) Reporting</h2>
<p>For each regimen <span class="math inline">\(r\)</span> and time
<span class="math inline">\(t\)</span>: report <span
class="math inline">\(\hat\psi_{r,\delta}(t)\)</span> across δ∈{0.75,
1.00, 1.25} (tables and plots), between‑regimen contrasts with 95% CIs,
and a succinct “forgiveness profile” summary (e.g., slope per 0.25
change in δ). Provide full diagnostics (positivity, SL weights, EIF
checks) in the appendix.</p>
</div>
<div id="simulation-internal-validation" class="section level2"
number="1.14">
<h2><span class="header-section-number">1.14</span> 14) Simulation
(internal validation)</h2>
<p>Accompany the analysis with a small simulation calibrated to the
study’s event rate, adherence distribution, and covariate structure,
varying (i) censoring informativeness, (ii) adherence predictiveness,
and (iii) degree of overlap, to verify estimator bias, variance, and
coverage under plausible scenarios.</p>
</div>
</div>
<div id="roadmap-step-0-define-the-causal-question"
class="section level1" number="2">
<h1><span class="header-section-number">2</span> 0. Roadmap Step 0:
Define the causal question</h1>
<p>We compare two first‑line ART regimens (Drug A vs Drug B) on the
<strong>risk of a safety event</strong> (e.g., AKI) by 12 months in
routine care where adherence fluctuates and switching can occur. The
target is <strong>policy‑relevant risk at fixed times</strong> (6, 12
months) rather than a hazard ratio. We explicitly preserve
<em>imperfect</em> adherence patterns observed in practice.</p>
<p><strong>Primary estimand (real‑world initiation effect under
imperfect adherence).</strong><br />
Let <span class="math inline">\(A_t\in\{0,1\}\)</span> indicate regimen
at visit <span class="math inline">\(t\)</span> (1=A, 0=B), <span
class="math inline">\(W\)</span> baseline covariates, <span
class="math inline">\(L_t\)</span> time‑varying predictors (e.g.,
adherence proxy, side‑effects), and <span
class="math inline">\(Y\)</span> the 12‑month safety event (1=event).
Define two feasible interventions that <strong>set only the baseline
regimen</strong> (initiation) and leave the subsequent regimen/adherence
process unchanged:</p>
<ul>
<li><span class="math inline">\(d^{\text{init}=A}\)</span>: set <span
class="math inline">\(A_1=1\)</span>, leave <span
class="math inline">\(A_{t&gt;1}\)</span> and <span
class="math inline">\(L_t\)</span> as observed (natural course).</li>
<li><span class="math inline">\(d^{\text{init}=B}\)</span>: set <span
class="math inline">\(A_1=0\)</span>, leave <span
class="math inline">\(A_{t&gt;1}\)</span> and <span
class="math inline">\(L_t\)</span> as observed.</li>
</ul>
<p>We target <span
class="math inline">\(E\{Y(d^{\text{init}=A})\}\)</span> and <span
class="math inline">\(E\{Y(d^{\text{init}=B})\}\)</span>, reporting RD
and RR. This is a <strong>real‑world initiation</strong> effect
(sometimes informally called “ITT‑like” in longitudinal settings) and
<em>does not</em> assume perfect regimen persistence. We estimate it
with <code>{lmtp}</code> by supplying a shift function that modifies
only <code>A1</code>. :contentReference<span index="5">oaicite:5</span>
:contentReference<span index="6">oaicite:6</span></p>
<p><strong>Secondary estimands (for context).</strong></p>
<ol style="list-style-type: decimal">
<li><strong>Per‑protocol static regimens</strong> (perfect persistence):
set all <span class="math inline">\(A_t\equiv 1\)</span> vs all <span
class="math inline">\(A_t\equiv 0\)</span>. Useful comparator, but not
“imperfect adherence”. <code>{lmtp}</code> supports static policies via
<code>static_binary_on/off</code>. :contentReference<span
index="7">oaicite:7</span> :contentReference<span
index="8">oaicite:8</span><br />
</li>
<li><strong>Incremental propensity score interventions (IPSI)</strong>:
stochastically increase/decrease the odds of choosing Drug A at each
decision by a factor <span class="math inline">\(\delta\)</span> to
study <em>forgiveness</em> to suboptimal uptake/adherence. Implemented
via <code>ipsi(delta)</code>. :contentReference<span
index="9">oaicite:9</span></li>
</ol>
</div>
<div
id="roadmap-step-1-specify-causal-model-interventions-and-estimands"
class="section level1" number="3">
<h1><span class="header-section-number">3</span> 1. Roadmap Step 1:
Specify causal model, interventions, and estimands</h1>
<p>We adopt a longitudinal causal structure <span
class="math inline">\(W \rightarrow A_1 \rightarrow L_2 \rightarrow A_2
\rightarrow \cdots \rightarrow Y\)</span>, with switching driven by
measured <span class="math inline">\(L_t\)</span> (e.g., adherence,
toxicity). Competing death can be handled as censoring or as a competing
risk depending on the safety question (we show both encodings below).
<code>{lmtp}</code> estimators target <strong>marginal risks</strong>
<span class="math inline">\(E\{Y(d)\}\)</span> at the horizon; contrasts
are RD and RR. :contentReference<span index="10">oaicite:10</span>
:contentReference<span index="11">oaicite:11</span></p>
</div>
<div id="roadmap-step-2-identification-assumptions"
class="section level1" number="4">
<h1><span class="header-section-number">4</span> 2. Roadmap Step 2:
Identification assumptions</h1>
<p>Under the usual conditions—consistency, sequential exchangeability
given past <span class="math inline">\((W,\bar L_t,\bar A_t)\)</span>,
positivity, and correct (or flexible) nuisance learning—<span
class="math inline">\(E\{Y(d)\}\)</span> is identified from the observed
data. For survival/competing risk encodings we additionally use the
standard “degenerate outcome vector (LOCF)” and optional competing risk
formulation in <code>{lmtp}</code>. :contentReference<span
index="12">oaicite:12</span> :contentReference<span
index="13">oaicite:13</span></p>
</div>
<div id="roadmap-step-3-observed-data-structure-wide"
class="section level1" number="5">
<h1><span class="header-section-number">5</span> 3. Roadmap Step 3:
Observed data structure (wide)</h1>
<p>We store data in wide format with one row per person. For <span
class="math inline">\(K=4\)</span> regimen decisions (baseline, 3
follow‑ups) we will have: - Baseline: <code>W_*</code> (baseline
confounders). - Time‑varying covariates before each decision:
<code>L1</code> (pre‑A1), <code>L2</code> (pre‑A2), <code>L3</code>,
<code>L4</code>. - Regimens: <code>A1</code>, <code>A2</code>,
<code>A3</code>, <code>A4</code>. - Censoring indicators per interval:
<code>C1</code>…<code>C4</code> (1=uncensored through interval).<br />
- Outcome: <code>Y</code> (AKI by 12m).</p>
<p>This mirrors the layout recommended in your draft and the tutorials.
(See the example table of node ordering in the <em>Survival
Analysis</em> and <em>Dynamic Regimes</em> tutorials.)
:contentReference<span index="14">oaicite:14</span>
:contentReference<span index="15">oaicite:15</span></p>
</div>
<div id="roadmap-step-4-estimation-strategy" class="section level1"
number="6">
<h1><span class="header-section-number">6</span> 4. Roadmap Step 4:
Estimation strategy</h1>
<p>We use <code>{lmtp}</code> with the <strong>TMLE</strong> or
<strong>SDR</strong> estimator and Super Learner nuisance fits. Function
signatures and arguments below follow the package manual.
:contentReference<span index="16">oaicite:16</span></p>
<pre class="r"><code># Core
library(lmtp)
library(SuperLearner)

# Helpers
library(dplyr)
library(tidyr)
library(broom)     # for tidy() on results if desired
library(survival)  # for the Cox illustration
library(readr)</code></pre>
</div>
<div id="simulated-ehrstyle-cohort-with-imperfect-adherence"
class="section level1" number="7">
<h1><span class="header-section-number">7</span> 5. Simulated EHR‑style
cohort with imperfect adherence</h1>
<p>We simulate baseline risk, time‑varying adherence/toxicity
(<code>L_t</code>), regimen switching, event hazards, and censoring.
Drug A is safer (lower AKI hazard) <em>if taken</em>, but switching
depends on <code>L_t</code> and prior adherence—creating time‑varying
confounding by indication.</p>
<pre class="r"><code>sim_art &lt;- function(n = 4000, K = 4) {

  # Baseline
  W_age  &lt;- rnorm(n, 45, 10)
  W_cd4  &lt;- pmax(50, rnorm(n, 500, 150))
  W_male &lt;- rbinom(n, 1, 0.55)
  W0 &lt;- data.frame(age = W_age, cd4 = W_cd4, male = W_male)

  # Pre-A1 covariate (e.g., baseline pill burden tolerance / expected adherence)
  L1 &lt;- pmin(pmax(rnorm(n, 0, 1), -3), 3)

  # Baseline regimen choice (depends on W0, L1)
  logit_pA1 &lt;- -0.2 + 0.25*(W_male) - 0.002*(W_cd4 - 500)/100 + 0.4*L1
  A1 &lt;- rbinom(n, 1, plogis(logit_pA1))

  # Containers
  L &lt;- matrix(NA_real_, n, K)     # L1..L4 (we&#39;ll fill L1 plus L2..L4)
  A &lt;- matrix(NA_integer_, n, K)  # A1..A4
  C &lt;- matrix(1L, n, K)           # C1..C4 (1=uncensored through interval)
  Yk &lt;- rep(0L, n)                # running event indicator
  T_event &lt;- rep(K+1L, n)         # first event time if any (for Cox illustration)

  L[,1] &lt;- L1
  A[,1] &lt;- A1

  # Effects: Drug A reduces hazard; higher L_t increases hazard and promotes switching
  beta_A   &lt;- -0.8
  beta_L   &lt;-  0.6
  beta_W   &lt;-  0.15
  base_logit &lt;- -3.2

  for (k in 1:K) {
    # For k &gt;= 2, generate new L_k depending on last A_{k-1} and L_{k-1}
    if (k &gt;= 2) {
      mu_L &lt;- 0.2*(1 - A[,k-1]) + 0.5*plogis(L[,k-1]) + 0.1*scale(W_cd4) # toxicity/adherence proxy
      L[,k] &lt;- pmin(pmax(rnorm(n, mu_L, 0.8), -3), 3)
    }

    # Event occurrence in interval k if not yet occurred:
    lp &lt;- base_logit + beta_A*A[,k] + beta_L*L[,k] + beta_W*scale(W_age)[,1]
    prob_event &lt;- plogis(lp)
    new_event &lt;- rbinom(n, 1, prob_event) * (Yk == 0L)
    just_happened &lt;- which(new_event == 1L)
    if (length(just_happened)) {
      Yk[just_happened] &lt;- 1L
      T_event[just_happened] &lt;- pmin(T_event[just_happened], k)
    }

    # Random censoring (e.g., death/LTFU) depending on W and L
    pcens &lt;- plogis(-3 + 0.3*scale(W_age)[,1] + 0.25*L[,k])
    cens_k &lt;- rbinom(n, 1, pcens) * (rowSums(C, na.rm=TRUE) == k-1) # first time to censor
    if (any(cens_k == 1L)) {
      i &lt;- which(cens_k == 1L)
      C[i, k:K] &lt;- 0L
    }

    # For next decision (k&lt;K), allow switching driven by L_{k+1} and last A_k
    if (k &lt; K) {
      logit_pA_next &lt;- -0.3 + 1.2*A[,k] - 0.9*(L[,k] &gt; 0.8) + 0.3*L[,k]
      A[,k+1] &lt;- rbinom(n, 1, plogis(logit_pA_next))
    }
  }

  # Final binary outcome by 12m: event before or at K and uncensored through K
  Y &lt;- as.integer((T_event &lt;= K) &amp; (C[,K] == 1L))

  # Assemble wide data frame
  df &lt;- data.frame(
    age = W_age, cd4 = W_cd4, male = W_male,
    L1 = L[,1], A1 = A[,1],
    L2 = L[,2], A2 = A[,2],
    L3 = L[,3], A3 = A[,3],
    L4 = L[,4], A4 = A[,4],
    C1 = C[,1], C2 = C[,2], C3 = C[,3], C4 = C[,4],
    Y = Y,
    T_event = T_event # for Cox illustration
  )
  df
}

dat &lt;- sim_art(n = 4000, K = 4)
dplyr::glimpse(dat)</code></pre>
<pre><code>## Rows: 4,000
## Columns: 17
## $ age     &lt;dbl&gt; 52.25569, 40.21411, 47.53183, 36.23729, 36.35069, 34.53482, 38…
## $ cd4     &lt;dbl&gt; 595.8644, 615.0071, 587.2401, 314.6777, 550.0154, 301.8767, 69…
## $ male    &lt;int&gt; 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1,…
## $ L1      &lt;dbl&gt; 1.15158635, 0.42872759, -2.05268083, -0.20674968, 0.38007439, …
## $ A1      &lt;int&gt; 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0,…
## $ L2      &lt;dbl&gt; 1.50582451, 1.38440448, -0.55648820, 2.19348973, 0.04260401, 0…
## $ A2      &lt;int&gt; 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1,…
## $ L3      &lt;dbl&gt; 0.0143392, 1.1419257, -0.4498635, -0.4461040, 1.1638515, -0.23…
## $ A3      &lt;int&gt; 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1,…
## $ L4      &lt;dbl&gt; -0.16415034, 0.40702111, 0.52242246, 0.58620812, -0.01216547, …
## $ A4      &lt;int&gt; 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0,…
## $ C1      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ C2      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ C3      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ C4      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ Y       &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1,…
## $ T_event &lt;dbl&gt; 5, 5, 5, 5, 5, 5, 5, 1, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 2, 5, 2,…</code></pre>
<blockquote>
<p><strong>Note:</strong> The wide layout above is exactly what
<code>{lmtp}</code> expects: a vector of treatments
<code>trt = c("A1","A2","A3","A4")</code>, a list of time‑varying
covariates aligned by decision times
<code>time_vary = list(c("L1"),c("L2"),c("L3"),c("L4"))</code>,
censoring indicators <code>cens = c("C1","C2","C3","C4")</code>, and a
single binary outcome <code>Y</code>. See the package manual for
argument definitions.</p>
</blockquote>
</div>
<div id="node-specification" class="section level1" number="8">
<h1><span class="header-section-number">8</span> 6. Node
specification</h1>
<pre class="r"><code>trt_nodes &lt;- c(&quot;A1&quot;,&quot;A2&quot;,&quot;A3&quot;,&quot;A4&quot;)
baseline  &lt;- c(&quot;age&quot;,&quot;cd4&quot;,&quot;male&quot;)
time_vary &lt;- list(c(&quot;L1&quot;), c(&quot;L2&quot;), c(&quot;L3&quot;), c(&quot;L4&quot;))
cens_nodes &lt;- c(&quot;C1&quot;,&quot;C2&quot;,&quot;C3&quot;,&quot;C4&quot;)
outcome &lt;- &quot;Y&quot;

# modest, fast SL library (expand in real analysis)
sl_lib &lt;- c(&quot;SL.mean&quot;, &quot;SL.glm&quot;, &quot;SL.glmnet&quot;)</code></pre>
</div>
<div id="define-interventions" class="section level1" number="9">
<h1><span class="header-section-number">9</span> 7. Define
interventions</h1>
<p><strong>(a) Real‑world initiation (imperfect adherence
preserved).</strong><br />
Shift only <code>A1</code>, leave later <code>A_t</code> as
observed.</p>
<pre class="r"><code>d_initiate_A &lt;- function(data, trt) ifelse(trt == &quot;A1&quot;, 1L, data[[trt]])
d_initiate_B &lt;- function(data, trt) ifelse(trt == &quot;A1&quot;, 0L, data[[trt]])</code></pre>
<p><strong>(b) Per‑protocol static regimens (perfect persistence;
comparator).</strong><br />
Use built‑ins <code>static_binary_on</code> (all <span
class="math inline">\(A_t=1\)</span>) and <code>static_binary_off</code>
(all <span class="math inline">\(A_t=0\)</span>).</p>
<pre class="r"><code># Provided by {lmtp}; no code needed beyond referencing them.
# static_binary_on; static_binary_off</code></pre>
<p><strong>(c) Incremental propensity policies (forgiveness analysis;
optional).</strong><br />
Increase the odds of choosing Drug A at every decision point by, e.g.,
25% (<code>ipsi(1.25)</code>), or decrease by 25%
(<code>ipsi(0.75)</code>).</p>
<pre class="r"><code># e.g., ipsi_up &lt;- ipsi(1.25); ipsi_down &lt;- ipsi(0.75)</code></pre>
</div>
<div id="estimation-with-lmtp" class="section level1" number="10">
<h1><span class="header-section-number">10</span> 8. Estimation with
<code>{lmtp}</code></h1>
<p>We estimate <span class="math inline">\(E\{Y(d)\}\)</span> under each
policy using TMLE (or SDR). Argument names and defaults follow the
manual. :contentReference<span index="20">oaicite:20</span></p>
<pre class="r"><code>fit_initA &lt;- lmtp_tmle(
  data = dat,
  trt = trt_nodes,
  outcome = outcome,
  baseline = baseline,
  time_vary = time_vary,
  cens = cens_nodes,
  shift = d_initiate_A,
  outcome_type = &quot;binomial&quot;,
  learners_trt = sl_lib,
  learners_outcome = sl_lib,
  folds = 5
)

fit_initB &lt;- lmtp_tmle(
  data = dat,
  trt = trt_nodes,
  outcome = outcome,
  baseline = baseline,
  time_vary = time_vary,
  cens = cens_nodes,
  shift = d_initiate_B,
  outcome_type = &quot;binomial&quot;,
  learners_trt = sl_lib,
  learners_outcome = sl_lib,
  folds = 5
)

# Contrasts for real‑world initiation (A vs B)
rd_init &lt;- lmtp_contrast(fit_initA, ref = fit_initB, type = &quot;additive&quot;)
rr_init &lt;- lmtp_contrast(fit_initA, ref = fit_initB, type = &quot;rr&quot;)
rd_init; rr_init</code></pre>
<pre><code>## 
##   shift   ref estimate std.error conf.low conf.high p.value
## 1 0.157 0.186   -0.029    0.0353  -0.0981    0.0401   0.411</code></pre>
<pre><code>## 
##   shift   ref estimate std.error conf.low conf.high p.value
## 1 0.157 0.186    0.844     0.179    0.493      1.19  &lt;0.001</code></pre>
<pre class="r"><code># Optional: “forgiveness” analysis via IPSI
fit_ipsi_up &lt;- lmtp_tmle(
  data = dat, trt = trt_nodes, outcome = outcome,
  baseline = baseline, time_vary = time_vary, cens = cens_nodes,
  shift = ipsi(1.25),
  outcome_type = &quot;binomial&quot;,
  learners_trt = sl_lib, learners_outcome = sl_lib, folds = 5
)
tidy(fit_ipsi_up)  # risk trajectory under IPSI</code></pre>
<blockquote>
<p>For dynamic and survival examples, see the “Beyond the ATE”
exercises; the code here matches their <code>lmtp_sdr/lmtp_tmle</code>
usage and contrast pattern.</p>
</blockquote>
</div>
<div id="diagnostics-and-design-checks" class="section level1"
number="11">
<h1><span class="header-section-number">11</span> 9. Diagnostics and
design checks</h1>
<ul>
<li><strong>Positivity:</strong> tabulate observed treatment across
strata of <span class="math inline">\(L_t\)</span>/<span
class="math inline">\(W\)</span>; inspect estimated treatment/censoring
hazards to ensure no extremes.<br />
</li>
<li><strong>Learner sanity:</strong> verify Super Learner didn’t
degenerate (e.g., both GLM and GLMnet used).<br />
</li>
<li><strong>Sensitivity:</strong> compare TMLE to SDR; vary SL
library.</li>
</ul>
<p>These checks parallel those in your draft planning document and HTML
tutorial.</p>
<pre class="r"><code>with(dat, prop.table(table(cut(L2, breaks = quantile(L2, seq(0,1,0.2), include.lowest=TRUE)), A2), 1))</code></pre>
<pre><code>##                 A2
##                         0        1
##   (-2.4,-0.346]  0.456821 0.543179
##   (-0.346,0.124] 0.476250 0.523750
##   (0.124,0.558]  0.490000 0.510000
##   (0.558,1.05]   0.506250 0.493750
##   (1.05,3]       0.480000 0.520000</code></pre>
</div>
<div id="optional-competing-risks-encoding-in-lmtp"
class="section level1" number="12">
<h1><span class="header-section-number">12</span> 10. (Optional)
Competing risks encoding in <code>{lmtp}</code></h1>
<p>When the safety outcome is subject to a competing event (e.g., death
precluding AKI ascertainment), encode <strong>degenerate outcome
vectors</strong> <code>Y_1…Y_K</code> and specify either (i) treat
competing event as censoring (<code>cens = ...</code>) or (ii) as a
competing risk (<code>compete = ...</code>) to target <strong>cumulative
incidence</strong> effects. The tutorials show this pattern and how to
flip/LOCF the deterministic columns prior to fitting.
:contentReference<span index="25">oaicite:25</span></p>
<pre class="r"><code># Sketch only (simulate Y_1..Y_K and D_0..D_{K-1}, then):
fit_compete &lt;- lmtp_sdr(
  data     = dat_surv,               # wide with Y_1..Y_K
  trt      = paste0(&quot;A&quot;, 1:K),
  outcome  = paste0(&quot;Y_&quot;, 1:K),
  baseline = baseline,
  time_vary= lapply(1:K, function(k) paste0(&quot;L&quot;, k)),
  compete  = paste0(&quot;D_&quot;, 0:(K-1)),  # competing event indicators
  shift    = d_initiate_A,           # or static_binary_on/off, ipsi(..), etc.
  mtp      = TRUE,                   # TRUE for modified/stochastic policies
  outcome_type = &quot;survival&quot;,
  folds = 5
)
tidy(fit_compete)</code></pre>
<blockquote>
<p>See the survival tutorial for the precise LOCF and
<code>compete</code> argument usage and interpretation of
<strong>cumulative incidence</strong> effects. :contentReference<span
index="26">oaicite:26</span></p>
</blockquote>
</div>
<div
id="why-a-cox-model-with-timevarying-covariates-may-not-be-sufficient"
class="section level1" number="13">
<h1><span class="header-section-number">13</span> 11. Why a Cox model
with time‑varying covariates may not be sufficient</h1>
<p><strong>Conceptual issues.</strong> A Cox HR among survivors is a
<em>conditional</em> estimand that can suffer from selection bias
(conditioning on survival), non‑collapsibility (HR changes with
covariate sets even without confounding), model dependence (PH
assumption), and—if time‑varying adherence (e.g., PDC) is
included—possible adjustment for an <strong>intermediate/confounded
mediator</strong>, shifting the target estimand away from the marginal
policy‑relevant causal risk. Your methods slides summarize these
pitfalls succinctly in the ART context. :contentReference<span
index="27">oaicite:27</span></p>
<p><strong>Illustration on the simulated data.</strong> Below we reshape
to counting‑process format and fit a time‑varying Cox model. Its HR need
not approximate the marginal RD/RR from <code>{lmtp}</code> because (i)
it’s conditional on survival and (ii) it conflates structural and design
choices (e.g., whether to adjust for <span
class="math inline">\(L_t\)</span>/PDC). This chunk is for
demonstration; the coefficient values will generally disagree with the
LMTP contrasts.</p>
<pre class="r"><code># Build start-stop dataset with time-varying A and L
#### Cox illustration (robust) ####
suppressPackageStartupMessages({library(dplyr); library(tidyr); library(survival)})

# Infer K from treatment columns A1..AK
K &lt;- length(grep(&quot;^A\\d+$&quot;, names(dat)))
stopifnot(K &gt;= 1)

dat &lt;- tibble::as_tibble(dat) %&gt;% mutate(id = row_number())

# Wide→long for node families present
# Expect any of these families to exist in your data: A,L,C,Y
families_present &lt;- paste0(&quot;^(&quot;, paste(c(&quot;A&quot;,&quot;L&quot;,&quot;C&quot;,&quot;Y&quot;), collapse=&quot;|&quot;), &quot;)\\d+$&quot;)
long &lt;- dat %&gt;%
  pivot_longer(
    cols = matches(families_present),
    names_to   = c(&quot;.value&quot;,&quot;t&quot;),
    names_pattern = &quot;([A-Z]+)(\\d+)&quot;
  ) %&gt;%
  mutate(t = as.integer(t)) %&gt;%
  arrange(id, t) %&gt;%
  mutate(start = t - 1L, stop = t)

# ---------- Create an incident-event column ----------
# Case 1: You encoded Y1..YK (preferred). After pivot, that&#39;s a single column Y (0/1 *by t*).
if (&quot;Y&quot; %in% names(long)) {
  long &lt;- long %&gt;%
    group_by(id) %&gt;%
    mutate(
      # incident event at time t if Y turns 1 for the first time at t
      event = as.integer(Y == 1L &amp; dplyr::lag(cummax(replace_na(Y,0L)), default = 0L) == 0L)
    ) %&gt;%
    ungroup()
} else if (&quot;T_event&quot; %in% names(dat)) {
  # Case 2: Only a terminal event time exists (T_event); mark the interval where stop == T_event
  long &lt;- long %&gt;%
    left_join(dat %&gt;% select(id, T_event), by = &quot;id&quot;) %&gt;%
    mutate(event = as.integer(stop == T_event)) %&gt;%
    select(-T_event)
} else {
  stop(&quot;No per-interval Y1..YK and no T_event found. Please either (i) construct Y1..YK, or (ii) supply T_event.&quot;)
}

# Optional: drop post-event intervals, keeping the first event interval
long &lt;- long %&gt;%
  group_by(id) %&gt;%
  mutate(any_event = cumsum(event) &gt; 0L) %&gt;%
  filter(!lag(any_event, default = FALSE) | event == 1L) %&gt;%
  ungroup() %&gt;%
  select(-any_event)

# Fit Cox model with time‑varying A and (optionally) L
cox_fit &lt;- coxph(Surv(start, stop, event) ~ A + L + age + cd4 + male, data = long)
summary(cox_fit)</code></pre>
<pre><code>## Call:
## coxph(formula = Surv(start, stop, event) ~ A + L + age + cd4 + 
##     male, data = long)
## 
##   n= 14332, number of events= 556 
## 
##            coef  exp(coef)   se(coef)      z Pr(&gt;|z|)    
## A    -0.3921465  0.6756051  0.0881053 -4.451 8.55e-06 ***
## L     0.1486883  1.1603113  0.0432432  3.438 0.000585 ***
## age   0.0123977  1.0124749  0.0042402  2.924 0.003457 ** 
## cd4   0.0008299  1.0008302  0.0002826  2.937 0.003317 ** 
## male -0.0637385  0.9382504  0.0850489 -0.749 0.453596    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
##      exp(coef) exp(-coef) lower .95 upper .95
## A       0.6756     1.4802    0.5685    0.8029
## L       1.1603     0.8618    1.0660    1.2629
## age     1.0125     0.9877    1.0041    1.0209
## cd4     1.0008     0.9992    1.0003    1.0014
## male    0.9383     1.0658    0.7942    1.1084
## 
## Concordance= 0.585  (se = 0.013 )
## Likelihood ratio test= 44.5  on 5 df,   p=2e-08
## Wald test            = 44.23  on 5 df,   p=2e-08
## Score (logrank) test = 44.41  on 5 df,   p=2e-08</code></pre>
<blockquote>
<p>LMTP returns marginal risks under explicit policies; Cox returns a
conditional hazard ratio tied to modeling assumptions and the chosen
covariate set. For policy decisions we prefer risk contrasts at
clinically meaningful times, as emphasized in the tutorials.
:contentReference<span index="28">oaicite:28</span>
:contentReference<span index="29">oaicite:29</span></p>
</blockquote>
</div>
<div id="reporting-the-results" class="section level1" number="14">
<h1><span class="header-section-number">14</span> 12. Reporting the
results</h1>
<p>Report <span
class="math inline">\(\widehat{E}\{Y(d^{\text{init}=A})\},
\widehat{E}\{Y(d^{\text{init}=B})\}\)</span> and their RD/RR with CIs;
include positivity diagnostics (no extreme estimated hazards/weights),
SL library used, and sensitivity (e.g., SDR vs TMLE, IPSI grids). This
mirrors the patterns in your HTML drafts and our earlier “Longitudinal
ART under imperfect adherence” plan. :contentReference<span
index="30">oaicite:30</span> :contentReference<span
index="31">oaicite:31</span></p>
</div>
<div id="reproducibility-appendix" class="section level1" number="15">
<h1><span class="header-section-number">15</span> 13. Reproducibility
appendix</h1>
<ul>
<li><code>{lmtp}</code> function arguments and estimator options
(TMLE/SDR, <code>outcome_type</code>, <code>compete</code>) are
specified per the package manual. :contentReference<span
index="32">oaicite:32</span><br />
</li>
<li>Dynamic/static regime examples align with the “Beyond the ATE” DTR
tutorial. :contentReference<span index="33">oaicite:33</span><br />
</li>
<li>Survival/competing risks encoding and interpretation follow the
survival tutorial. :contentReference<span
index="34">oaicite:34</span><br />
</li>
<li>Incremental propensity score interventions (<code>ipsi</code>)
follow the IPSI tutorial. :contentReference<span
index="35">oaicite:35</span></li>
<li>The overall step‑wise structure mirrors your HTML tutorial’s “Step
0–5” navigation. :contentReference<span
index="36">oaicite:36</span></li>
</ul>
<hr />
<div id="notes-on-reconciliation-with-your-files" class="section level2"
number="15.1">
<h2><span class="header-section-number">15.1</span> Notes on
reconciliation with your files</h2>
<ul>
<li>The prior draft focused on <strong>perfect persistence</strong>;
here the <em>primary</em> analysis is <strong>baseline initiation with
natural subsequent adherence/switching</strong> via a custom shift that
only sets <code>A1</code>. This is the key pivot to <em>imperfect
adherence</em>. (Your HTML menu and outline were used to structure
sections and chunk names.) :contentReference<span
index="37">oaicite:37</span></li>
<li>Where helpful, I included contextual static policies (per‑protocol)
and an IPSI variant to trace “forgiveness” curves—both are first‑class
<code>{lmtp}</code> use cases. :contentReference<span
index="38">oaicite:38</span> :contentReference<span
index="39">oaicite:39</span></li>
<li>Survival/competing risk remarks follow the official examples (LOCF,
<code>compete=</code>), so you can extend to cumulative incidence if the
safety outcome is event‑time based. :contentReference<span
index="40">oaicite:40</span></li>
</ul>
<!-- If you want, I can now run a small grid of IPSI deltas (e.g., 0.75, 1.00, 1.25) and return a table/plot of estimated risk vs. delta to visualize regimen “forgiveness.” -->
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
